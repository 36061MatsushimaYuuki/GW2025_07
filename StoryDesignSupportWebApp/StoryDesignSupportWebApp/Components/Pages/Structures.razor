@page "/projects/edit/{id:int}/structure"

@rendermode InteractiveServer
@attribute [Authorize]

@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using StoryDesignSupportWebApp.Data
@using StoryDesignSupportWebApp.Data.EditData
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject UserManager<ApplicationUser> UserManager
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@inject ProtectedSessionStorage SessionStorage

<PageTitle>LunaStory - 構成</PageTitle>

<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        overflow: hidden;
    }

    .edit-container {
        display: flex;
        height: calc(100vh - 5.5rem);
        overflow: hidden;
        max-width: 100vw;
        transition: height 0.3s ease;
    }

    /* サイドバー */
    .sidebar {
        width: 300px;
        background-color: #fafbfc;
        border-right: 1px solid #e1e4e8;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        position: relative;
        transition: margin-left 0.3s ease;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.04);
    }

        .sidebar.collapsed {
            margin-left: -300px;
            width: 300px;
        }

    .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #e1e4e8;
        background-color: #0066cc;
        cursor: pointer;
        color: white;
        font-weight: 600;
        transition: all 0.2s ease;
    }

        .sidebar-header:hover {
            background-color: #0550ae;
        }

    .sidebar-toggle {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background-color: #0969da;
        color: white;
        border: none;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        z-index: 10;
        box-shadow: 0 3px 10px rgba(9, 105, 218, 0.25);
        transition: all 0.2s ease;
    }

        .sidebar-toggle:hover {
            background-color: #0550ae;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(9, 105, 218, 0.35);
        }

    .sidebar-open-btn {
        position: fixed;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        background-color: #0969da;
        color: white;
        border: none;
        border-radius: 0 8px 8px 0;
        width: 36px;
        height: 56px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        z-index: 10;
        box-shadow: 3px 0 10px rgba(9, 105, 218, 0.25);
        transition: all 0.2s ease;
    }

        .sidebar-open-btn:hover {
            background-color: #0550ae;
            transform: translateY(-50%);
            box-shadow: 3px 0 15px rgba(9, 105, 218, 0.35);
        }

    .category-view {
        flex: 1;
        overflow-y: auto;
    }

    .category-item {
        padding: 16px 20px;
        height: 60px;
        border-bottom: 1px solid #e1e4e8;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
        border-left: 3px solid transparent;
    }

        .category-item:hover {
            background-color: #f6f8fa;
            border-left-color: #0969da;
        }

        .category-item.active {
            background-color: #ddf4ff;
            color: #0969da;
            border-left-color: #0969da;
            font-weight: 600;
        }

    /* エディタエリア */
    .editor-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #ffffff;
        overflow: hidden;
    }

    .editor-header {
        padding: 20px 30px;
        border-bottom: 1px solid #e1e4e8;
        background-color: #f6f8fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .editor-title {
        font-size: 24px;
        font-weight: 600;
        color: #24292f;
    }

    .editor-content {
        flex: 1;
        overflow-y: auto;
        padding: 30px 30px 20px 30px;
    }

    /* プロット編集用スタイル */
    .plot-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        height: 100%;
    }

    .plot-column {
        display: flex;
        flex-direction: column;
        padding-right: 10px;
        padding-left: 10px;
        min-height: 0;
    }

        .plot-column:not(:last-child) {
            border-right: lightgray solid;
        }

    .plot-column-header {
        font-size: 18px;
        font-weight: 600;
        padding: 12px 16px;
        background-color: #f6f8fa;
        border-radius: 6px;
        text-align: center;
        color: #24292f;
        border: 2px solid #d0d7de;
        margin-bottom: 10px;
    }

    .plot-items {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 100px;
    }

    .plot-item {
        background: white;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        padding: 12px;
        cursor: move;
        transition: all 0.2s ease;
        position: relative;
    }

        .plot-item:hover {
            border-color: #0969da;
            box-shadow: 0 2px 8px rgba(9, 105, 218, 0.15);
        }

        .plot-item.dragging {
            opacity: 0.5;
        }

        .plot-item.drag-over {
            border-color: #0969da;
            border-width: 2px;
            background-color: #ddf4ff;
        }

    .plot-item-textarea {
        width: 100%;
        height: 150px;
        border: none;
        outline: none;
        resize: none;
        font-size: 14px;
        line-height: 1.5;
        min-height: 60px;
        font-family: inherit;
    }

    .plot-item-actions {
        display: flex;
        position: absolute;
        justify-content: flex-end;
        gap: 8px;
        margin-top: -24px;
        right: 12px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .plot-item:hover .plot-item-actions {
        opacity: 1;
    }

    .plot-item-delete-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 12px;
        font-size: 12px;
        cursor: pointer;
        max-width: max-content;
        max-height: max-content;
        position: relative;
        transition: background 0.2s ease;
    }

        .plot-item-delete-btn:hover {
            background: #c82333;
        }

    .add-plot-btn {
        padding: 10px;
        background-color: #0969da;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        font-size: 14px;
        margin-top: 10px;
    }

        .add-plot-btn:hover {
            background-color: #0550ae;
        }

    /* 時系列編集用スタイル */
    .timeline-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
        padding: 40px;
        min-height: 100%;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #8c959f;
        font-size: 16px;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }

    /* モバイルビュー */
    .mobile-view {
        display: none;
        height: calc(100vh - 5.5rem);
        overflow: hidden;
        transition: height 0.3s ease;
    }

    .mobile-list {
        height: calc(100vh - 5.5rem);
        overflow-y: auto;
        background-color: #f5f5f5;
        transition: height 0.3s ease;
    }

    .mobile-header {
        padding: 15px;
        background-color: #0066cc;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .back-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
    }

    .mobile-title {
        flex: 1;
        font-size: 18px;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .mobile-category-item {
        padding: 16px 20px;
        height: 60px;
        border-bottom: 1px solid #e1e4e8;
        cursor: pointer;
        background-color: white;
        transition: background-color 0.2s ease;
    }

        .mobile-category-item:hover {
            background-color: #f6f8fa;
        }

    .mobile-editor {
        height: calc(100vh - 5.5rem);
        display: flex;
        flex-direction: column;
        background-color: #fff;
        transition: height 0.3s ease;
    }

    .mobile-editor-header {
        padding: 15px;
        background-color: #0066cc;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .mobile-editor-title {
        flex: 1;
        font-size: 18px;
        font-weight: bold;
    }

    .mobile-editor-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .mobile-plot-column:not(:last-child) {
        margin-bottom: 15px;
        border-bottom: lightgray solid;
    }

    .mobile-plot-column .add-plot-btn {
        margin-bottom: 15px;
    }

    .mobile-plot-header {
        font-size: 20px;
        font-weight: 600;
        padding: 12px 16px;
        background-color: #f6f8fa;
        border-radius: 6px;
        text-align: center;
        color: #24292f;
        border: 2px solid #d0d7de;
        margin-bottom: 15px;
    }

    .mobile-add-btn {
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background-color: #0969da;
        color: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(9, 105, 218, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        z-index: 100;
    }

        .mobile-add-btn:hover {
            background-color: #0550ae;
            transform: scale(1.1);
        }

    .mobile-column-selector {
        position: fixed;
        bottom: 90px;
        right: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 99;
    }

    .mobile-column-btn {
        padding: 10px 20px;
        background: white;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

        .mobile-column-btn:hover {
            background-color: #f6f8fa;
            border-color: #0969da;
        }

    /* レスポンシブ */
    @@media (max-width: 768px) {
        .desktop-view {
            display: none !important;
        }

        .mobile-view {
            display: block;
            width: 100%;
        }

        .sidebar-toggle,
        .sidebar-open-btn {
            display: none;
        }

        .plot-container {
            grid-template-columns: 1fr;
        }
    }

    .mobile-category-ui {
        position: sticky;
        display: flex;
        align-items: center;
        justify-content: center;
        bottom: 0;
        width: max-content;
        margin: 0 auto;
    }

    .category-select-button {
        width: 64px;
        height: 64px;
        cursor: pointer;
        line-height: 64px;
        text-align: center;
        align-items: center;
        justify-content: center;
        background-color: lightgrey;
        border: solid;
        border-color: grey;
    }

        .category-select-button + .category-select-button {
            border-left: none;
        }

        .category-select-button:first-child {
            border-top-left-radius: 10%;
            border-bottom-left-radius: 10%;
        }

        .category-select-button:last-child {
            border-top-right-radius: 10%;
            border-bottom-right-radius: 10%;
        }

        .category-select-button:hover {
            background-color: grey;
        }

        .category-select-button.active {
            background-color: #0066cc;
            color: white;
        }

            .category-select-button.active:hover {
                background-color: #0052a3;
            }
</style>

@if (_project == null) {
    <p>Loading...</p>
} else {
    <!-- デスクトップビュー -->
    <div class="edit-container desktop-view">
        @if (_sidebarCollapsed) {
            <button class="sidebar-open-btn" @onclick="ToggleSidebar">▶</button>
        }

        <div class="sidebar @(_sidebarCollapsed ? "collapsed" : "")">
            @if (_showCategoryView) {
                <div class="sidebar-header" @onclick="BackToCategoryView">
                    &lt; カテゴリ選択に戻る
                </div>
                <div class="category-view">
                    <div class="category-item @(_structureMode == "plot" ? "active" : "")" @onclick='() => SelectStructureMode("plot")'>
                        プロット
                    </div>
                    @* <div class="category-item @(_structureMode == "timeline" ? "active" : "")" @onclick='() => SelectStructureMode("timeline")'>
                        時系列
                    </div> *@
                </div>
            } else {
                <div class="sidebar-header" @onclick="BackToProjectList">
                    &lt; 一覧に戻る
                </div>
                <div class="category-view">
                    <div class="category-item" @onclick='() => SelectCategory("writing")'>
                        執筆
                    </div>
                    <div class="category-item @(_currentCategory == "structure" ? "active" : "")" @onclick='() => SelectCategory("structure")'>
                        構成
                    </div>
                    <div class="category-item" @onclick='() => SelectCategory("characters")'>
                        人物
                    </div>
                    <div class="category-item" @onclick='() => SelectCategory("materials")'>
                        資料
                    </div>
                </div>
            }
            @if (!_sidebarCollapsed) {
                <button class="sidebar-toggle" @onclick="ToggleSidebar">◀</button>
            }
        </div>

        <!-- エディタエリア -->
        <div class="editor-area">
            @if (_showCategoryView && _structureMode == "plot") {
                <div class="editor-header">
                    <div class="editor-title">プロット編集</div>
                </div>
                <div class="editor-content">
                    <div class="plot-container">
                        <!-- 起 -->
                        <div class="plot-column">
                            <div class="plot-column-header">起</div>
                            <div class="plot-items">
                                @if (_project.ProjectDataObject?.Structure?.Plots?.Ki != null) {
                                    @for (int i = 0; i < _project.ProjectDataObject.Structure.Plots.Ki.Length; i++) {
                                        var index = i;
                                        <div class="plot-item">
                                            <textarea class="plot-item-textarea"
                                                      @bind="_project.ProjectDataObject.Structure.Plots.Ki[index]"
                                                      @bind:event="oninput"
                                                      placeholder="プロットを入力..."></textarea>
                                            <div class="plot-item-actions">
                                                <button class="plot-item-delete-btn" @onclick='(() => DeletePlotItem("ki", index))'>削除</button>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <button class="add-plot-btn" @onclick='() => AddPlotItem("ki")'>+ 起を追加</button>
                        </div>

                        <!-- 承 -->
                        <div class="plot-column">
                            <div class="plot-column-header">承</div>
                            <div class="plot-items">
                                @if (_project.ProjectDataObject?.Structure?.Plots?.Shou != null) {
                                    @for (int i = 0; i < _project.ProjectDataObject.Structure.Plots.Shou.Length; i++) {
                                        var index = i;
                                        <div class="plot-item">
                                            <textarea class="plot-item-textarea"
                                                      @bind="_project.ProjectDataObject.Structure.Plots.Shou[index]"
                                                      @bind:event="oninput"
                                                      placeholder="プロットを入力..."></textarea>
                                            <div class="plot-item-actions">
                                                <button class="plot-item-delete-btn" @onclick='(() => DeletePlotItem("shou", index))'>削除</button>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <button class="add-plot-btn" @onclick='() => AddPlotItem("shou")'>+ 承を追加</button>
                        </div>

                        <!-- 転 -->
                        <div class="plot-column">
                            <div class="plot-column-header">転</div>
                            <div class="plot-items">
                                @if (_project.ProjectDataObject?.Structure?.Plots?.Ten != null) {
                                    @for (int i = 0; i < _project.ProjectDataObject.Structure.Plots.Ten.Length; i++) {
                                        var index = i;
                                        <div class="plot-item">
                                            <textarea class="plot-item-textarea"
                                                      @bind="_project.ProjectDataObject.Structure.Plots.Ten[index]"
                                                      @bind:event="oninput"
                                                      placeholder="プロットを入力..."></textarea>
                                            <div class="plot-item-actions">
                                                <button class="plot-item-delete-btn" @onclick='(() => DeletePlotItem("ten", index))'>削除</button>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <button class="add-plot-btn" @onclick='() => AddPlotItem("ten")'>+ 転を追加</button>
                        </div>

                        <!-- 結 -->
                        <div class="plot-column">
                            <div class="plot-column-header">結</div>
                            <div class="plot-items">
                                @if (_project.ProjectDataObject?.Structure?.Plots?.Ketsu != null) {
                                    @for (int i = 0; i < _project.ProjectDataObject.Structure.Plots.Ketsu.Length; i++) {
                                        var index = i;
                                        <div class="plot-item">
                                            <textarea class="plot-item-textarea"
                                                      @bind="_project.ProjectDataObject.Structure.Plots.Ketsu[index]"
                                                      @bind:event="oninput"
                                                      placeholder="プロットを入力..."></textarea>
                                            <div class="plot-item-actions">
                                                <button class="plot-item-delete-btn" @onclick='(() => DeletePlotItem("ketsu", index))'>削除</button>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <button class="add-plot-btn" @onclick='() => AddPlotItem("ketsu")'>+ 結を追加</button>
                        </div>
                    </div>
                </div>
            } else if (_showCategoryView && _structureMode == "timeline") {
                <div class="editor-header">
                    <div class="editor-title">時系列編集 - フロー図</div>
                </div>
                <div class="editor-content">
                    <div class="timeline-container">
                        @if (_project.ProjectDataObject?.Scenario?.Chapters != null && _project.ProjectDataObject.Scenario.Chapters.Length > 0) {

                        } else {
                            <div class="empty-state">
                                <div>章と話を追加すると時系列が表示されます</div>
                            </div>
                        }
                    </div>
                </div>
            } else {
                @if (_showCategoryView) {
                    <div class="empty-state">
                        構成モードを選択してください
                    </div>
                } else {
                    <div class="empty-state">
                        左のサイドバーからカテゴリーを選択してください
                    </div>
                }
            }
        </div>
    </div>

    <!-- モバイルビュー -->
    <div class="mobile-view">
        @if (_mobileShowEditor) {
            @if (_structureMode == "plot") {
                <div class="mobile-editor">
                    <div class="mobile-editor-header">
                        <button class="back-btn" @onclick="BackToModeSelect">&lt;</button>
                        <div class="mobile-editor-title">プロット編集</div>
                    </div>
                    <div class="mobile-editor-content">
                        <!-- 起 -->
                        <div class="mobile-plot-column">
                            <div class="mobile-plot-header">起</div>
                            <div class="plot-items">
                                @if (_project.ProjectDataObject?.Structure?.Plots?.Ki != null) {
                                    @for (int i = 0; i < _project.ProjectDataObject.Structure.Plots.Ki.Length; i++) {
                                        var index = i;
                                        <div class="plot-item">
                                            <textarea class="plot-item-textarea"
                                                      @bind="_project.ProjectDataObject.Structure.Plots.Ki[index]"
                                                      @bind:event="oninput"
                                                      placeholder="プロットを入力..."></textarea>
                                            <div class="plot-item-actions" style="opacity: 1;">
                                                <button class="plot-item-delete-btn" @onclick='(() => DeletePlotItem("ki", index))'>削除</button>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <button class="add-plot-btn" @onclick='() => AddPlotItem("ki")'>+ 起を追加</button>
                        </div>

                        <!-- 承 -->
                        <div class="mobile-plot-column">
                            <div class="mobile-plot-header">承</div>
                            <div class="plot-items">
                                @if (_project.ProjectDataObject?.Structure?.Plots?.Shou != null) {
                                    @for (int i = 0; i < _project.ProjectDataObject.Structure.Plots.Shou.Length; i++) {
                                        var index = i;
                                        <div class="plot-item">
                                            <textarea class="plot-item-textarea"
                                                      @bind="_project.ProjectDataObject.Structure.Plots.Shou[index]"
                                                      @bind:event="oninput"
                                                      placeholder="プロットを入力..."></textarea>
                                            <div class="plot-item-actions" style="opacity: 1;">
                                                <button class="plot-item-delete-btn" @onclick='(() => DeletePlotItem("shou", index))'>削除</button>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <button class="add-plot-btn" @onclick='() => AddPlotItem("shou")'>+ 承を追加</button>
                        </div>

                        <!-- 転 -->
                        <div class="mobile-plot-column">
                            <div class="mobile-plot-header">転</div>
                            <div class="plot-items">
                                @if (_project.ProjectDataObject?.Structure?.Plots?.Ten != null) {
                                    @for (int i = 0; i < _project.ProjectDataObject.Structure.Plots.Ten.Length; i++) {
                                        var index = i;
                                        <div class="plot-item">
                                            <textarea class="plot-item-textarea"
                                                      @bind="_project.ProjectDataObject.Structure.Plots.Ten[index]"
                                                      @bind:event="oninput"
                                                      placeholder="プロットを入力..."></textarea>
                                            <div class="plot-item-actions" style="opacity: 1;">
                                                <button class="plot-item-delete-btn" @onclick='(() => DeletePlotItem("ten", index))'>削除</button>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <button class="add-plot-btn" @onclick='() => AddPlotItem("ten")'>+ 転を追加</button>
                        </div>

                        <!-- 結 -->
                        <div class="mobile-plot-column">
                            <div class="mobile-plot-header">結</div>
                            <div class="plot-items">
                                @if (_project.ProjectDataObject?.Structure?.Plots?.Ketsu != null) {
                                    @for (int i = 0; i < _project.ProjectDataObject.Structure.Plots.Ketsu.Length; i++) {
                                        var index = i;
                                        <div class="plot-item">
                                            <textarea class="plot-item-textarea"
                                                      @bind="_project.ProjectDataObject.Structure.Plots.Ketsu[index]"
                                                      @bind:event="oninput"
                                                      placeholder="プロットを入力..."></textarea>
                                            <div class="plot-item-actions" style="opacity: 1;">
                                                <button class="plot-item-delete-btn" @onclick='(() => DeletePlotItem("ketsu", index))'>削除</button>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <button class="add-plot-btn" style="margin-bottom: 0;" @onclick='() => AddPlotItem("ketsu")'>+ 結を追加</button>
                        </div>
                    </div>
                </div>
            } else if (_structureMode == "timeline") {
                <div class="mobile-editor">
                    <div class="mobile-editor-header">
                        <button class="back-btn" @onclick="BackToModeSelect">&lt;</button>
                        <div class="mobile-editor-title">時系列編集</div>
                    </div>
                    <div class="mobile-editor-content">
                        <div class="timeline-container" style="padding: 20px;">
                            @if (_project.ProjectDataObject?.Scenario?.Chapters != null && _project.ProjectDataObject.Scenario.Chapters.Length > 0) {

                            } else {
                                <div class="empty-state">
                                    <div>章と話を追加すると時系列が表示されます</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        } else {
            <div class="mobile-list">
                <div class="mobile-header">
                    <button class="back-btn" @onclick="BackToProjectList">&lt;</button>
                    <div class="mobile-title">プロジェクト一覧に戻る</div>
                </div>
                <div class="mobile-category-item" @onclick='() => SelectStructureModeMobile("plot")'>
                    プロット
                </div>
                @* <div class="mobile-category-item" @onclick='() => SelectStructureModeMobile("timeline")'>
                    時系列
                </div> *@
            </div>
            <div class="mobile-category-ui">
                <div class="category-select-button" @onclick='() => SelectCategory("writing")'>執筆</div>
                <div class="category-select-button active" @onclick='() => SelectCategory("structure")'>構成</div>
                <div class="category-select-button" @onclick='() => SelectCategory("characters")'>人物</div>
                <div class="category-select-button" @onclick='() => SelectCategory("materials")'>資料</div>
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public int id { get; set; }

    private Project? _project;
    private string _currentCategory = "structure";
    private bool _showCategoryView = true;
    private string _structureMode = "";
    private bool _mobileShowEditor = false;
    private bool _sidebarCollapsed = false;

    // デスクトップ/モバイル判定
    private bool _isMobile = false;

    protected override async Task OnInitializedAsync() {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var appUser = await UserManager.GetUserAsync(user);
        var userId = appUser.Id;

        _project = await DbFactory
            .CreateDbContext()
            .Projects
            .Where(x => x.Id == id && x.UserId == userId)
            .FirstOrDefaultAsync();

        if (_project == null) {
            Nav.NavigateTo("/projects");
            return;
        }

        // StructureDataの初期化
        if (_project.ProjectDataObject.Structure == null) {
            _project.ProjectDataObject.Structure = new StructureData();
        }

        // PlotDataの初期化
        if (_project.ProjectDataObject.Structure.Plots == null) {
            _project.ProjectDataObject.Structure.Plots = new PlotData {
                Ki = Array.Empty<string>(),
                Shou = Array.Empty<string>(),
                Ten = Array.Empty<string>(),
                Ketsu = Array.Empty<string>()
            };
        }

        // TimeLineDataの初期化
        if (_project.ProjectDataObject.Structure.Timeline == null) {
            _project.ProjectDataObject.Structure.Timeline = new TimeLineData {
                ChapterId = Array.Empty<int>(),
                SectionId = Array.Empty<int>()
            };
        }

        // ScenarioDataの初期化（時系列用）
        if (_project.ProjectDataObject.Scenario == null) {
            _project.ProjectDataObject.Scenario = new ScenarioData {
                Chapters = Array.Empty<Chapter>()
            };
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            _isMobile = await JSRuntime.InvokeAsync<bool>("eval", "window.innerWidth <= 768");
            StateHasChanged();
        }
        await JSRuntime.InvokeVoidAsync("adjustContainerHeight");
    }

    private async Task BackToCategoryView() {
        await SaveProject();
        _showCategoryView = false;
        _structureMode = "";
        StateHasChanged();
    }

    private async Task BackToProjectList() {
        await SaveProject();
        Nav.NavigateTo("/projects");
    }

    private async Task SaveProject() {
        if (_project != null && _project.ProjectDataObject != null) {
            _project.UpdatedAt = DateTime.UtcNow;
            await using var db = DbFactory.CreateDbContext();
            db.Projects.Update(_project);
            await db.SaveChangesAsync();
        }
    }

    private async Task SelectCategory(string category) {
        _currentCategory = category;
        if (category == "writing") {
            await SaveProject();
            Nav.NavigateTo($"/projects/edit/{id}");
        } else if (category == "structure") {
            _showCategoryView = true;
        } else if (category == "characters") {
            await SaveProject();
            Nav.NavigateTo($"/projects/edit/{id}/characters");
        } else if (category == "materials") {
            await SaveProject();
            Nav.NavigateTo($"/projects/edit/{id}/materials");
        }

        StateHasChanged();
    }

    private void SelectStructureMode(string mode) {
        _structureMode = mode;
        if (mode == "timeline") {

        }
        StateHasChanged();
    }

    private void SelectStructureModeMobile(string mode) {
        _structureMode = mode;
        _mobileShowEditor = true;
        if (mode == "timeline") {

        }
        StateHasChanged();
    }

    private void BackToModeSelect() {
        _mobileShowEditor = false;
        StateHasChanged();
    }

    private void ToggleSidebar() {
        _sidebarCollapsed = !_sidebarCollapsed;
    }

    // プロット編集メソッド
    private async Task AddPlotItem(string column) {
        if (_project?.ProjectDataObject?.Structure?.Plots == null) return;

        var plots = _project.ProjectDataObject.Structure.Plots;

        switch (column.ToLower()) {
            case "ki":
                var kiList = plots.Ki?.ToList() ?? new List<string>();
                kiList.Add("");
                plots.Ki = kiList.ToArray();
                break;
            case "shou":
                var shouList = plots.Shou?.ToList() ?? new List<string>();
                shouList.Add("");
                plots.Shou = shouList.ToArray();
                break;
            case "ten":
                var tenList = plots.Ten?.ToList() ?? new List<string>();
                tenList.Add("");
                plots.Ten = tenList.ToArray();
                break;
            case "ketsu":
                var ketsuList = plots.Ketsu?.ToList() ?? new List<string>();
                ketsuList.Add("");
                plots.Ketsu = ketsuList.ToArray();
                break;
        }

        await SaveProject();
        StateHasChanged();
    }

    private async Task DeletePlotItem(string column, int index) {
        if (_project?.ProjectDataObject?.Structure?.Plots == null) return;

        var plots = _project.ProjectDataObject.Structure.Plots;

        switch (column.ToLower()) {
            case "ki":
                if (plots.Ki != null && index >= 0 && index < plots.Ki.Length) {
                    var kiList = plots.Ki.ToList();
                    kiList.RemoveAt(index);
                    plots.Ki = kiList.ToArray();
                }
                break;
            case "shou":
                if (plots.Shou != null && index >= 0 && index < plots.Shou.Length) {
                    var shouList = plots.Shou.ToList();
                    shouList.RemoveAt(index);
                    plots.Shou = shouList.ToArray();
                }
                break;
            case "ten":
                if (plots.Ten != null && index >= 0 && index < plots.Ten.Length) {
                    var tenList = plots.Ten.ToList();
                    tenList.RemoveAt(index);
                    plots.Ten = tenList.ToArray();
                }
                break;
            case "ketsu":
                if (plots.Ketsu != null && index >= 0 && index < plots.Ketsu.Length) {
                    var ketsuList = plots.Ketsu.ToList();
                    ketsuList.RemoveAt(index);
                    plots.Ketsu = ketsuList.ToArray();
                }
                break;
        }

        await SaveProject();
        StateHasChanged();
    }
}

<script>
    function adjustContainerHeight() {
        const topRow = document.querySelector('.top-row');
        const desktopContainer = document.querySelector('.edit-container.desktop-view');
        const mobileContainer = document.querySelector('.mobile-view');
        const mobileView = document.querySelector('.mobile-list');
        const mobileEditor = document.querySelector('.mobile-editor');

        if (topRow) {
            const isCollapsed = topRow.classList.contains('collapsed');
            const height = isCollapsed ? 'calc(100vh - 2rem)' : 'calc(100vh - 5.5rem)';

            if (desktopContainer) desktopContainer.style.height = height;
            if (mobileContainer) mobileContainer.style.height = height;
            if (mobileView) mobileView.style.height = height;
            if (mobileEditor) mobileEditor.style.height = height;
        }
    }

    window.adjustContainerHeight = adjustContainerHeight;
</script>