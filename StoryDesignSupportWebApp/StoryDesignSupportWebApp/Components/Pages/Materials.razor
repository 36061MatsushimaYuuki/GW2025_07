@page "/projects/edit/{id:int}/materials"
@rendermode InteractiveServer
@attribute [Authorize]
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using StoryDesignSupportWebApp.Data
@using StoryDesignSupportWebApp.Data.EditData
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject UserManager<ApplicationUser> UserManager
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@inject ProtectedSessionStorage SessionStorage
<PageTitle>LunaStory - 資料</PageTitle>
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html, body {
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden;
        background-color: #F3F6FB;
        font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    }

    body {
        overflow: hidden;
    }

    .edit-container {
        display: flex;
        height: calc(100dvh - 5.5rem);
        overflow: hidden;
        max-width: 100vw;
        transition: height 0.3s ease;
    }

    .sidebar {
        width: 300px;
        background-color: #FAFCFF;
        border-right: 1px solid rgba(25, 118, 210, 0.12);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        position: relative;
        transition: margin-left 0.3s ease;
        box-shadow: 2px 0 12px rgba(25, 118, 210, 0.08);
    }

        .sidebar.collapsed {
            margin-left: -300px;
            width: 300px;
        }

    .sidebar-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(0,0,0,0.08);
        background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        cursor: pointer;
        color: white;
        font-weight: 600;
        font-size: 14px;
        letter-spacing: 0.5px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 6px rgba(25, 118, 210, 0.3);
    }

        .sidebar-header:hover {
            background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.4);
        }

    .sidebar-toggle {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background-color: #1565C0;
        color: white;
        border: none;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        z-index: 10;
        box-shadow: 0 5px 15px rgba(25, 118, 210, 0.4);
        transition: all 0.2s ease;
    }

        .sidebar-toggle:hover {
            background-color: #0550ae;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(9, 105, 218, 0.35);
        }

    .sidebar-open-btn {
        position: fixed;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        background-color: #1565C0;
        color: white;
        border: none;
        border-radius: 0 8px 8px 0;
        width: 36px;
        height: 56px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        z-index: 10;
        box-shadow: 0 5px 15px rgba(25, 118, 210, 0.4);
        transition: all 0.2s ease;
    }

        .sidebar-open-btn:hover {
            background-color: #0550ae;
            transform: translateY(-50%);
            box-shadow: 3px 0 15px rgba(9, 105, 218, 0.35);
        }

    .category-view, .material-view {
        flex: 1;
        overflow-y: auto;
    }

    .category-item {
        padding: 16px 20px;
        height: 60px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #FFFFFF;
        border-bottom: 1px solid rgba(0,0,0,0.06);
        border-left: 3px solid transparent;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

        .category-item:hover {
            background-color: #E3F2FD;
            border-left-color: #1976D2;
        }

        .category-item.active {
            background-color: #BBDEFB;
            color: #1565C0;
            border-left-color: #1976D2;
            font-weight: 600;
        }

        .category-item.dragging {
            opacity: 0.6;
            background-color: #f6f8fa;
        }

        .category-item.drag-over-top {
            border-top: 3px solid #1976D2;
            background-color: #E3F2FD;
        }

        .category-item.drag-over-bottom {
            border-bottom: 3px solid #1976D2;
            background-color: #E3F2FD;
        }

    .category-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .category-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .category-count {
        color: #656d76;
        font-size: 13px;
        font-weight: 400;
        flex-shrink: 0;
    }

    .category-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .category-item:hover .category-actions {
        opacity: 1;
    }

    .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        padding: 4px;
        transition: color 0.2s ease;
    }

        .icon-btn img {
            margin-top: -3px;
            max-width: 18px;
            height: auto;
            filter: brightness(0) saturate(100%) invert(39%) sepia(0%) saturate(1132%) hue-rotate(181deg) brightness(97%) contrast(81%);
        }

        .icon-btn:hover img {
            filter: brightness(0) saturate(100%) invert(15%) sepia(0%) saturate(1213%) hue-rotate(202deg) brightness(91%) contrast(83%);
        }

        .icon-btn.delete {
            background: none;
            padding: 0 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #ff2222;
            font-weight: bold;
            margin-right: -8px;
        }

            .icon-btn.delete:hover {
                color: #ff1111;
            }

    .add-category-btn, .add-material-btn {
        margin: 16px;
        padding: 10px 16px;
        background: linear-gradient(135deg, #1976D2, #1565C0);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        letter-spacing: 0.3px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.25);
    }

        .add-category-btn:hover, .add-material-btn:hover {
            background: linear-gradient(135deg, #1565C0, #0D47A1);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(25, 118, 210, 0.35);
        }

        .add-category-btn.mobile, .add-material-btn.mobile {
            padding: 0px;
            height: 48px;
            width: 48px;
            font-size: 20px;
            text-align: center;
        }

    .material-item {
        padding: 16px 20px;
        height: 60px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #FFFFFF;
        border-bottom: 1px solid rgba(0,0,0,0.06);
        border-left: 3px solid transparent;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

        .material-item:hover {
            background-color: #E3F2FD;
            border-left-color: #1976D2;
        }

        .material-item.active {
            background-color: #BBDEFB;
            color: #1565C0;
            border-left-color: #1976D2;
            font-weight: 600;
        }

        .material-item.dragging {
            opacity: 0.6;
            background-color: #f6f8fa;
        }

        .material-item.drag-over-top {
            border-top: 3px solid #1976D2;
            background-color: #E3F2FD;
        }

        .material-item.drag-over-bottom {
            border-bottom: 3px solid #1976D2;
            background-color: #E3F2FD;
        }

    .material-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .material-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .material-item:hover .material-actions {
        opacity: 1;
    }

    .material-list-panel {
        width: 300px;
        background-color: #fafbfc;
        border-right: 1px solid #e1e4e8;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        position: relative;
        transition: margin-left 0.3s ease;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.04);
    }

    .material-list-header {
        padding: 15px;
        border-bottom: 1px solid #e1e4e8;
        background-color: #f6f8fa;
        color: white;
        font-weight: 600;
        transition: all 0.2s ease;
        color: #24292f;
        font-size: 16px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .editor-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #F8FAFF;
        overflow: hidden;
    }

    .editor-header {
        padding: 15px;
    }

    .editor-title-input {
        width: 100%;
        font-size: 18px;
        font-weight: 600;
        border: none;
        margin: 0 12px;
        background: transparent;
        outline: none;
        border-bottom: 2px solid rgba(25, 118, 210, 0.2);
        color: #1C1B1F;
        transition: border-color 0.2s ease;
    }

        .editor-title-input:focus {
            border-bottom-color: #1976D2;
        }

        .editor-title-input::placeholder {
            color: #8c959f;
        }

    .editor-content {
        flex: 1;
        overflow: hidden;
        padding: 30px 0 30px 30px;
    }

    .editor-textarea {
        width: 100%;
        min-height: 400px;
        height: 100%;
        border: 1px solid rgba(25, 118, 210, 0.2);
        border-radius: 10px;
        background-color: #FFFFFF;
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        padding: 12px;
        font-size: 16px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        line-height: 1.6;
        resize: none;
        outline: none;
        transition: border-color 0.2s ease;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

        .editor-textarea:focus {
            border-color: #1976D2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.12);
            outline: none;
        }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #8c959f;
        font-size: 16px;
    }

        .empty-state.category-bar {
            padding: 16px 20px;
            height: 60px;
            border-bottom: 1px solid #e1e4e8;
            justify-content: center;
            align-items: center;
        }

        .empty-state.material-bar {
            padding: 16px 20px;
            height: 60px;
            border-bottom: 1px solid #e1e4e8;
            justify-content: center;
            align-items: center;
        }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .modal-content {
        background: #ffffff;
        border-radius: 16px;
        padding: 24px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18), 0 2px 8px rgba(25, 118, 210, 0.08);
        animation: slideUp 0.3s ease;
    }

    @@keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #24292f;
    }

    .modal-body {
        margin-bottom: 20px;
    }

    .modal-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid rgba(25, 118, 210, 0.25);
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s ease;
    }

        .modal-input:focus {
            border-color: #1976D2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.12);
        }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .modal-btn-cancel {
        background-color: #f6f8fa;
        color: #24292f;
    }

        .modal-btn-cancel:hover {
            background-color: #e1e4e8;
        }

    .modal-btn-primary {
        color: white;
        background: linear-gradient(135deg, #1976D2, #1565C0);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(25, 118, 210, 0.3);
    }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #1565C0, #0D47A1);
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.4);
        }

    .modal-btn-danger {
        background-color: #dc3545;
        color: white;
    }

        .modal-btn-danger:hover {
            background-color: #c82333;
        }

    .modal-btn-secondary {
        background-color: #6c757d;
        color: white;
    }

        .modal-btn-secondary:hover {
            background-color: #5a6268;
        }

    .label-section {
        margin-top: 12px;
    }

    .label-section-title {
        font-size: 12px;
        font-weight: 600;
        color: #546E7A;
        margin-bottom: 6px;
        letter-spacing: 0.3px;
    }

    .label-input-row {
        display: flex;
        gap: 6px;
        align-items: center;
        margin-bottom: 8px;
    }

    .label-input {
        flex: 1;
        padding: 7px 10px;
        border: 1px solid rgba(25, 118, 210, 0.25);
        border-radius: 8px;
        font-size: 13px;
        outline: none;
        transition: border-color 0.2s ease;
    }

        .label-input:focus {
            border-color: #1976D2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.12);
        }

        .label-input:disabled {
            background-color: #F3F6FB;
            color: #aaa;
            cursor: not-allowed;
        }

    .label-add-btn {
        padding: 7px 12px;
        background: linear-gradient(135deg, #1976D2, #1565C0);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s ease;
        white-space: nowrap;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .label-add-btn:hover {
            background: linear-gradient(135deg, #1565C0, #0D47A1);
        }

        .label-add-btn:disabled {
            background: #CFD8DC;
            cursor: not-allowed;
        }

    .label-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        min-height: 28px;
    }

    .label-tag {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 3px 10px 3px 10px;
        background-color: #E3F2FD;
        color: #1565C0;
        border: 1px solid rgba(25, 118, 210, 0.25);
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .label-tag-remove {
        background: none;
        border: none;
        color: #90A4AE;
        cursor: pointer;
        font-size: 14px;
        padding: 0;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s ease;
    }

        .label-tag-remove:hover {
            color: #E53935;
        }

    .material-item-labels {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        margin-top: 3px;
    }

    .material-label-chip {
        display: inline-block;
        padding: 1px 7px;
        background-color: #E3F2FD;
        color: #1565C0;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 500;
        border: 1px solid rgba(25, 118, 210, 0.2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 80px;
    }

    .mobile-view {
        display: none;
        height: calc(100dvh - 5.5rem);
        overflow: hidden;
        transition: height 0.3s ease;
    }

    .mobile-list {
        display: flex;
        flex-direction: column;
        position: relative;
        height: calc(100dvh - 5.5rem);
        overflow-y: auto;
        background-color: #F3F6FB;
        transition: height 0.3s ease;
    }

    .mobile-header {
        padding: 15px;
        background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .back-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
    }

    .mobile-title {
        flex: 1;
        font-size: 18px;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .mobile-editor {
        height: calc(100dvh - 5.5rem);
        display: flex;
        flex-direction: column;
        background-color: #fff;
        transition: height 0.3s ease;
    }

    .mobile-editor-header {
        padding: 15px;
        background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .mobile-editor-title {
        flex: 1;
        font-size: 18px;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .mobile-editor-content {
        flex: 1;
        overflow: hidden;
        padding: 20px;
    }

    .mobile-title-input {
        width: 100%;
        font-size: 20px;
        font-weight: 600;
        border: none;
        border-bottom: 2px solid #e1e4e8;
        padding: 10px 0;
        margin-bottom: 20px;
        outline: none;
    }

        .mobile-title-input:focus {
            border-bottom-color: #0969da;
        }

    .mobile-textarea {
        width: 100%;
        height: 70%;
        min-height: 300px;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        padding: 12px;
        font-size: 14px;
        line-height: 1.6;
        resize: none;
        outline: none;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

        .mobile-textarea:focus {
            border-color: #0969da;
        }

    @@media (max-width: 768px) {
        .desktop-view {
            display: none !important;
        }

        .mobile-view {
            display: block;
            width: 100%;
        }

        .sidebar-toggle,
        .sidebar-open-btn {
            display: none;
        }

        .sidebar.collapsed {
            margin-left: 0;
            width: 300px;
        }

        .edit-container,
        .mobile-view,
        .mobile-list,
        .mobile-editor {
            height: calc(100dvh - 3.5rem);
        }

        .mobile-editor-content {
            padding: 12px;
        }

        .modal-content {
            width: 95%;
            padding: 16px;
        }

        .crop-modal-content {
            padding: 16px;
            gap: 10px;
        }
    }

    .mobile-category-ui {
        position: sticky;
        display: flex;
        align-items: center;
        justify-content: center;
        bottom: 0;
        width: max-content;
        margin: 0 auto;
        user-select: none;
        box-shadow: 0 4px 10px rgba(25, 118, 210, 0.4);
    }

    .category-select-button {
        width: 64px;
        height: 64px;
        cursor: pointer;
        line-height: 30px;
        text-align: center;
        background-color: #ECEFF1;
        border: 1px solid rgba(25, 118, 210, 0.15);
        color: #546E7A;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
        z-index: 100;
    }

        .category-select-button + .category-select-button {
            border-left: none;
        }

        .category-select-button:first-child {
            border-top-left-radius: 10%;
            border-bottom-left-radius: 10%;
        }

        .category-select-button:last-child {
            border-top-right-radius: 10%;
            border-bottom-right-radius: 10%;
        }

        .category-select-button:hover {
            background-color: #E3F2FD;
            color: #1976D2;
        }

        .category-select-button.active {
            background: linear-gradient(135deg, #1976D2, #1565C0);
            color: white;
            box-shadow: inset 0 -2px 4px rgba(0,0,0,0.15);
        }

            .category-select-button.active:hover {
                background: linear-gradient(135deg, #1565C0, #0D47A1);
            }

    .category-ui-flex {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

        .category-ui-flex img {
            max-width: 50%;
            margin-top: 8px;
            margin-bottom: -5px;
            height: auto;
            transition: all 0.2s ease;
            filter: brightness(0) saturate(100%) invert(41%) sepia(30%) saturate(370%) hue-rotate(154deg) brightness(91%) contrast(84%);
        }

        .category-ui-flex:hover img {
            filter: brightness(0) saturate(100%) invert(36%) sepia(76%) saturate(3916%) hue-rotate(196deg) brightness(92%) contrast(81%) invert(0%);
        }

        .category-ui-flex.active img {
            filter: none;
        }
</style>
@if (_project == null) {
    <p>Loading...</p>
} else {
    <div class="edit-container desktop-view">
        @if (_sidebarCollapsed) {
            <button class="sidebar-open-btn" @onclick="ToggleSidebar">▶</button>
        }
        <div class="sidebar @(_sidebarCollapsed ? "collapsed" : "")">
            @if (_showCategoryView) {
                <div class="sidebar-header" @onclick="BackToCategoryView">
                    &lt; カテゴリ選択に戻る
                </div>
                <div class="category-view">
                    @if (_project.ProjectDataObject?.Material?.Category != null && _project.ProjectDataObject.Material.Category.Length > 0) {
                        @for (int i = 0; i < _project.ProjectDataObject.Material.Category.Length; i++) {
                            var category = _project.ProjectDataObject.Material.Category[i];
                            var index = i;
                            <div class="category-item @(category == _selectedCategory ? "active" : "") @GetDragClass(index)"
                                 draggable="true"
                                 @ondragstart="() => HandleDragStart(index)"
                                 @ondragover="(e) => HandleDragOver(e, index)"
                                 @ondragover:preventDefault="true"
                                 @ondragleave="HandleDragLeave"
                                 @ondrop="() => HandleDrop(index)"
                                 @ondragend="HandleDragEnd"
                                 @onclick="() => SelectMaterialCategory(category)">
                                <span class="category-title">
                                    <span class="category-count">(@(category.Items?.Length ?? 0)件)</span>
                                    <span class="category-name">@category.Title</span>
                                </span>
                                <div class="category-actions">
                                    <button class="icon-btn" @onclick="() => ShowRenameCategoryModal(category)" @onclick:stopPropagation="true"><img src="/images/ui-rename.png" /></button>
                                    <button class="icon-btn delete" @onclick="() => ShowDeleteCategoryConfirm(category)" @onclick:stopPropagation="true">ー</button>
                                </div>
                            </div>
                        }
                    } else {
                        <div class="empty-state category-bar">
                            <div>資料カテゴリがありません</div>
                        </div>
                    }
                    <button class="add-category-btn" @onclick="ShowAddCategoryModal">+ カテゴリを追加</button>
                </div>
            } else {
                <div class="sidebar-header" @onclick="BackToProjectList">
                    &lt; プロジェクト一覧に戻る
                </div>
                <div class="category-view">
                    <div class="category-item" @onclick='() => SelectCategory("writing")'>
                        執筆
                    </div>
                    <div class="category-item" @onclick='() => SelectCategory("structure")'>
                        構成
                    </div>
                    <div class="category-item" @onclick='() => SelectCategory("characters")'>
                        人物
                    </div>
                    <div class="category-item @(_currentCategory == "materials" ? "active" : "")" @onclick='() => SelectCategory("materials")'>
                        資料
                    </div>
                </div>
            }
            @if (!_sidebarCollapsed) {
                <button class="sidebar-toggle" @onclick="ToggleSidebar">◀</button>
            }
        </div>
        @if (_showCategoryView && _selectedCategory != null) {
            <div class="material-list-panel">
                <div class="material-list-header">
                    資料一覧: @(_selectedCategory.Title ?? "")
                </div>
                <div class="material-view">
                    @if (_selectedCategory.Items != null && _selectedCategory.Items.Length > 0) {
                        @for (int i = 0; i < _selectedCategory.Items.Length; i++) {
                            var item = _selectedCategory.Items[i];
                            var index = i;
                            <div class="material-item @(item == _selectedMaterial ? "active" : "") @GetMaterialDragClass(index)"
                                 draggable="true"
                                 @ondragstart="() => HandleMaterialDragStart(index)"
                                 @ondragover="(e) => HandleMaterialDragOver(e, index)"
                                 @ondragover:preventDefault="true"
                                 @ondragleave="HandleMaterialDragLeave"
                                 @ondrop="() => HandleMaterialDrop(index)"
                                 @ondragend="HandleMaterialDragEnd"
                                 @onclick="() => SelectMaterial(item)">
                                <div style="flex: 1; overflow: hidden; min-width: 0;">
                                    <div class="material-title">@item.Title</div>
                                    @if (item.Label != null && item.Label.Length > 0) {
                                        <div class="material-item-labels">
                                            @foreach (var lbl in item.Label) {
                                                <span class="material-label-chip" title="@lbl">@lbl</span>
                                            }
                                        </div>
                                    }
                                </div>
                                <div class="material-actions">
                                    <button class="icon-btn" @onclick="() => ShowRenameMaterialModal(item)" @onclick:stopPropagation="true"><img src="/images/ui-rename.png" /></button>
                                    <button class="icon-btn delete" @onclick="() => ShowDeleteMaterialConfirm(item)" @onclick:stopPropagation="true">ー</button>
                                </div>
                            </div>
                        }
                    } else {
                        <div class="empty-state material-bar">
                            <div>資料がありません</div>
                        </div>
                    }
                    <button class="add-material-btn" @onclick="ShowAddMaterialModal">+ 資料を追加</button>
                </div>
            </div>
        }
        <div class="editor-area">
            @if (_showCategoryView && _selectedMaterial != null) {
                <div class="editor-header">
                    <input type="text" class="editor-title-input" placeholder="資料のタイトル" @bind="_selectedMaterial.Title" @bind:event="oninput" />
                    <div class="label-section">
                        <div class="label-section-title">ラベル（最大3つ・1つ20文字まで）</div>
                        <div class="label-input-row">
                            <input type="text"
                                   class="label-input"
                                   placeholder="ラベルを入力"
                                   maxlength="20"
                                   @bind="_labelInput"
                                   @bind:event="oninput"
                                   @onkeydown="HandleLabelKeyDown"
                                   disabled="@((_selectedMaterial.Label?.Length ?? 0) >= 3)" />
                            <button class="label-add-btn"
                                    @onclick="AddLabel"
                                    disabled="@(string.IsNullOrWhiteSpace(_labelInput) || (_selectedMaterial.Label?.Length ?? 0) >= 3)">
                                ＋
                            </button>
                        </div>
                        <div class="label-tags">
                            @if (_selectedMaterial.Label != null) {
                                @foreach (var lbl in _selectedMaterial.Label) {
                                    var capturedLabel = lbl;
                                    <span class="label-tag">
                                        @capturedLabel
                                        <button class="label-tag-remove" @onclick="() => RemoveLabel(capturedLabel)" @onclick:stopPropagation="true">×</button>
                                    </span>
                                }
                            }
                        </div>
                    </div>
                </div>
                <div class="editor-content">
                    <textarea class="editor-textarea" placeholder="資料の内容をここに入力してください..." @bind="_selectedMaterial.Text" @bind:event="oninput"></textarea>
                </div>
            } else if (_showCategoryView && _selectedCategory != null) {
                <div class="empty-state">
                    <div>資料を選択してください</div>
                </div>
            } else {
                @if (_showCategoryView) {
                    <div class="empty-state">
                        資料カテゴリを選択してください
                    </div>
                } else {
                    <div class="empty-state">
                        左のサイドバーからカテゴリーを選択してください
                    </div>
                }
            }
        </div>
    </div>
    <div class="mobile-view">
        @if (_mobileShowEditor) {
            <div class="mobile-editor">
                <div class="mobile-editor-header">
                    <button class="back-btn" @onclick="BackToMaterialList">&lt;</button>
                    <div class="mobile-editor-title">カテゴリ: @(_selectedCategory?.Title ?? "資料")</div>
                </div>
                <div class="mobile-editor-content">
                    @if (_selectedMaterial != null) {
                        <input type="text" class="mobile-title-input" placeholder="資料のタイトル" @bind="_selectedMaterial.Title" @bind:event="oninput" />
                        <div class="label-section" style="margin-bottom: 12px;">
                            <div class="label-section-title">ラベル（最大3つ・1つ20文字まで）</div>
                            <div class="label-input-row">
                                <input type="text"
                                       class="label-input"
                                       placeholder="ラベルを入力"
                                       maxlength="20"
                                       @bind="_labelInput"
                                       @bind:event="oninput"
                                       @onkeydown="HandleLabelKeyDown"
                                       disabled="@((_selectedMaterial.Label?.Length ?? 0) >= 3)" />
                                <button class="label-add-btn"
                                        @onclick="AddLabel"
                                        disabled="@(string.IsNullOrWhiteSpace(_labelInput) || (_selectedMaterial.Label?.Length ?? 0) >= 3)">
                                    ＋
                                </button>
                            </div>
                            <div class="label-tags">
                                @if (_selectedMaterial.Label != null) {
                                    @foreach (var lbl in _selectedMaterial.Label) {
                                        var capturedLabel = lbl;
                                        <span class="label-tag">
                                            @capturedLabel
                                            <button class="label-tag-remove" @onclick="() => RemoveLabel(capturedLabel)" @onclick:stopPropagation="true">×</button>
                                        </span>
                                    }
                                }
                            </div>
                        </div>
                        <textarea class="mobile-textarea" placeholder="資料の内容をここに入力してください..." @bind="_selectedMaterial.Text" @bind:event="oninput"></textarea>
                    }
                </div>
            </div>
        } else if (_mobileShowMaterialList) {
            <div class="mobile-list">
                <div class="mobile-header">
                    <button class="back-btn" @onclick="BackToCategoryListMobile">&lt;</button>
                    <div class="mobile-title">カテゴリ: @(_selectedCategory?.Title ?? "資料")</div>
                </div>
                <div class="material-view">
                    @if (_selectedCategory?.Items != null && _selectedCategory.Items.Length > 0) {
                        @for (int i = 0; i < _selectedCategory.Items.Length; i++) {
                            var item = _selectedCategory.Items[i];
                            var index = i;
                            <div class="material-item @GetMaterialDragClass(index)"
                                 draggable="true"
                                 @ondragstart="() => HandleMaterialDragStart(index)"
                                 @ondragover="(e) => HandleMaterialDragOver(e, index)"
                                 @ondragover:preventDefault="true"
                                 @ondragleave="HandleMaterialDragLeave"
                                 @ondrop="() => HandleMaterialDrop(index)"
                                 @ondragend="HandleMaterialDragEnd"
                                 @onclick="() => SelectMaterialMobile(item)">
                                <div style="flex: 1; overflow: hidden; min-width: 0;">
                                    <div class="material-title">@item.Title</div>
                                    @if (item.Label != null && item.Label.Length > 0) {
                                        <div class="material-item-labels">
                                            @foreach (var lbl in item.Label) {
                                                <span class="material-label-chip" title="@lbl">@lbl</span>
                                            }
                                        </div>
                                    }
                                </div>
                                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                    <button class="icon-btn" @onclick="() => ShowRenameMaterialModal(item)" @onclick:stopPropagation="true"><img src="/images/ui-rename.png" /></button>
                                    <button class="icon-btn delete" @onclick="() => ShowDeleteMaterialConfirm(item)" @onclick:stopPropagation="true">ー</button>
                                </div>
                            </div>
                        }
                    } else {
                        <div class="empty-state material-bar">
                            <div>資料がありません</div>
                        </div>
                    }
                    <button class="add-material-btn mobile" @onclick="ShowAddMaterialModal">＋</button>
                </div>
            </div>
        } else {
            <div class="mobile-list">
                <div class="mobile-header">
                    <button class="back-btn" @onclick="BackToProjectList">&lt;</button>
                    <div class="mobile-title">資料: プロジェクト一覧に戻る</div>
                </div>
                <div class="category-view">
                    @if (_project.ProjectDataObject?.Material?.Category != null && _project.ProjectDataObject.Material.Category.Length > 0) {
                        @for (int i = 0; i < _project.ProjectDataObject.Material.Category.Length; i++) {
                            var category = _project.ProjectDataObject.Material.Category[i];
                            var index = i;
                            <div class="category-item @GetDragClass(index)"
                                 draggable="true"
                                 @ondragstart="() => HandleDragStart(index)"
                                 @ondragover="(e) => HandleDragOver(e, index)"
                                 @ondragover:preventDefault="true"
                                 @ondragleave="HandleDragLeave"
                                 @ondrop="() => HandleDrop(index)"
                                 @ondragend="HandleDragEnd"
                                 @onclick="() => SelectMaterialCategoryMobile(category)">
                                <div class="category-title">
                                    <div class="category-count">(@(category.Items?.Length ?? 0)件)</div>
                                    <div class="category-name">@category.Title</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="icon-btn" @onclick="() => ShowRenameCategoryModal(category)" @onclick:stopPropagation="true"><img src="/images/ui-rename.png" /></button>
                                    <button class="icon-btn delete" @onclick="() => ShowDeleteCategoryConfirm(category)" @onclick:stopPropagation="true">ー</button>
                                </div>
                            </div>
                        }
                    } else {
                        <div class="empty-state category-bar">
                            <div>資料カテゴリがありません</div>
                        </div>
                    }
                    <button class="add-category-btn mobile" @onclick="ShowAddCategoryModal">＋</button>
                </div>
            </div>
        }
        @if (!_mobileShowEditor) {
            <div class="mobile-category-ui">
                <div class="category-select-button" @onclick='() => SelectCategory("writing")'>
                    <div class="category-ui-flex">
                        <img src="/images/ui-edit.png" />
                        執筆
                    </div>
                </div>
                <div class="category-select-button" @onclick='() => SelectCategory("structure")'>
                    <div class="category-ui-flex">
                        <img src="/images/ui-structure.png" />
                        構成
                    </div>
                </div>
                <div class="category-select-button" @onclick='() => SelectCategory("characters")'>
                    <div class="category-ui-flex">
                        <img src="/images/ui-character.png" />
                        人物
                    </div>
                </div>
                <div class="category-select-button active" @onclick='() => SelectCategory("materials")'>
                    <div class="category-ui-flex active">
                        <img src="/images/ui-material.png" />
                        資料
                    </div>
                </div>
            </div>
        }
    </div>
    @if (_showCategoryModal) {
        <div class="modal-overlay" @onclick="CloseCategoryModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">@(_isEditingCategory ? "カテゴリ名を編集" : "新しいカテゴリ")</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" placeholder="カテゴリ名を入力" @bind="_categoryModalTitle" @bind:event="oninput" @onkeydown="HandleCategoryModalKeyDown" />
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-cancel" @onclick="CloseCategoryModal">キャンセル</button>
                    <button class="modal-btn modal-btn-primary" @onclick="SaveCategory">保存</button>
                </div>
            </div>
        </div>
    }
    @if (_showMaterialModal) {
        <div class="modal-overlay" @onclick="CloseMaterialModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">@(_isEditingMaterial ? "資料名を編集" : "新しい資料")</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" placeholder="資料名を入力" @bind="_materialModalTitle" @bind:event="oninput" @onkeydown="HandleMaterialModalKeyDown" />
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-cancel" @onclick="CloseMaterialModal">キャンセル</button>
                    <button class="modal-btn modal-btn-primary" @onclick="SaveMaterial">保存</button>
                </div>
            </div>
        </div>
    }
    @if (_showDeleteCategoryConfirm) {
        <div class="modal-overlay" @onclick="CloseDeleteCategoryConfirm">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">カテゴリの削除</div>
                <div class="modal-body">
                    <p>このカテゴリを削除してもよろしいですか？</p>
                    <p style="color: #dc3545; margin-top: 10px;">※このカテゴリに含まれるすべての資料も削除されます。</p>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" @onclick="CloseDeleteCategoryConfirm">キャンセル</button>
                    <button class="modal-btn modal-btn-danger" @onclick="DeleteCategory">削除</button>
                </div>
            </div>
        </div>
    }
    @if (_showDeleteMaterialConfirm) {
        <div class="modal-overlay" @onclick="CloseDeleteMaterialConfirm">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">資料の削除</div>
                <div class="modal-body">
                    <p>この資料を削除してもよろしいですか？</p>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" @onclick="CloseDeleteMaterialConfirm">キャンセル</button>
                    <button class="modal-btn modal-btn-danger" @onclick="DeleteMaterial">削除</button>
                </div>
            </div>
        </div>
    }
}
@code {
    [Parameter]
    public int id { get; set; }
    private Project? _project;
    private string _currentCategory = "materials";
    private bool _showCategoryView = true;
    private bool _mobileShowEditor = false;
    private bool _mobileShowMaterialList = false;
    private MaterialCategory? _selectedCategory;
    private MaterialItem? _selectedMaterial;
    private bool _showCategoryModal = false;
    private bool _showMaterialModal = false;
    private string _categoryModalTitle = "";
    private string _materialModalTitle = "";
    private bool _isEditingCategory = false;
    private bool _isEditingMaterial = false;
    private bool _showDeleteCategoryConfirm = false;
    private bool _showDeleteMaterialConfirm = false;
    private MaterialCategory? _editingCategory;
    private MaterialItem? _editingMaterial;
    private bool _sidebarCollapsed = false;
    private string _labelInput = "";
    private bool _isMobile = false;
    private string? _lastPcContent = null;
    private string? _lastMobileContent = null;
    protected override async Task OnInitializedAsync() {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var appUser = await UserManager.GetUserAsync(user);
        var userId = appUser.Id;
        _project = await DbFactory
            .CreateDbContext()
            .Projects
            .Where(x => x.Id == id && x.UserId == userId)
            .FirstOrDefaultAsync();
        if (_project == null) {
            Nav.NavigateTo("/projects");
            return;
        }
        if (_project.ProjectDataObject.Material == null) {
            _project.ProjectDataObject.Material = new MaterialData();
        }
        if (_project.ProjectDataObject.Material.Category == null) {
            _project.ProjectDataObject.Material.Category = Array.Empty<MaterialCategory>();
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            _isMobile = await JSRuntime.InvokeAsync<bool>("eval", "window.innerWidth <= 768");
            if (_isMobile) {
                _lastMobileContent = _selectedMaterial?.Text ?? "";
            } else {
                _lastPcContent = _selectedMaterial?.Text ?? "";
            }
            StateHasChanged();
        } else {
            bool currentIsMobile = await JSRuntime.InvokeAsync<bool>("eval", "window.innerWidth <= 768");
            if (_isMobile != currentIsMobile) {
                if (currentIsMobile && !_isMobile) {
                    _lastMobileContent = _lastPcContent;
                    if (_selectedMaterial != null) {
                        _selectedMaterial.Text = _lastMobileContent ?? "";
                    }
                } else if (!currentIsMobile && _isMobile) {
                    _lastPcContent = _lastMobileContent;
                    if (_selectedMaterial != null) {
                        _selectedMaterial.Text = _lastPcContent ?? "";
                    }
                }
                _isMobile = currentIsMobile;
                StateHasChanged();
            } else {
                if (_isMobile) {
                    _lastMobileContent = _selectedMaterial?.Text ?? "";
                } else {
                    _lastPcContent = _selectedMaterial?.Text ?? "";
                }
            }
        }
        await JSRuntime.InvokeVoidAsync("adjustContainerHeight");
    }
    private async Task BackToCategoryView() {
        await SaveProject();
        _showCategoryView = false;
        _selectedCategory = null;
        _selectedMaterial = null;
        StateHasChanged();
    }
    private async Task BackToProjectList() {
        await SaveProject();
        Nav.NavigateTo("/projects");
    }
    private async Task SaveProject() {
        if (_project != null && _project.ProjectDataObject != null) {
            _project.UpdatedAt = DateTime.UtcNow;
            await using var db = DbFactory.CreateDbContext();
            db.Projects.Update(_project);
            await db.SaveChangesAsync();
        }
    }
    private async Task SelectCategory(string category) {
        _currentCategory = category;
        if (category == "writing") {
            await SaveProject();
            Nav.NavigateTo($"/projects/edit/{id}");
        } else if (category == "structure") {
            await SaveProject();
            Nav.NavigateTo($"/projects/edit/{id}/structure");
        } else if (category == "characters") {
            await SaveProject();
            Nav.NavigateTo($"/projects/edit/{id}/characters");
        } else if (category == "materials") {
            _showCategoryView = true;
        }
        StateHasChanged();
    }
    private void SelectMaterialCategory(MaterialCategory category) {
        _selectedCategory = category;
        _selectedMaterial = category.Items?.FirstOrDefault();
        StateHasChanged();
    }
    private void SelectMaterial(MaterialItem material) {
        _selectedMaterial = material;
        StateHasChanged();
    }
    private async Task AddLabel() {
        if (_selectedMaterial == null) return;
        var trimmed = _labelInput.Trim();
        if (string.IsNullOrEmpty(trimmed)) return;
        var labels = _selectedMaterial.Label?.ToList() ?? new List<string>();
        if (labels.Count >= 3) return;
        if (labels.Contains(trimmed)) {
            _labelInput = "";
            return;
        }
        labels.Add(trimmed);
        _selectedMaterial.Label = labels.ToArray();
        _labelInput = "";
        await SaveProject();
        StateHasChanged();
    }
    private async Task RemoveLabel(string label) {
        if (_selectedMaterial == null) return;
        var labels = _selectedMaterial.Label?.ToList() ?? new List<string>();
        labels.Remove(label);
        _selectedMaterial.Label = labels.Count > 0 ? labels.ToArray() : null;
        await SaveProject();
        StateHasChanged();
    }
    private async Task HandleLabelKeyDown(KeyboardEventArgs e) {
        if (e.Key == "Enter") {
            await AddLabel();
        }
    }
    private void SelectMaterialCategoryMobile(MaterialCategory category) {
        _selectedCategory = category;
        _mobileShowMaterialList = true;
        StateHasChanged();
    }
    private void SelectMaterialMobile(MaterialItem material) {
        _selectedMaterial = material;
        _mobileShowEditor = true;
        StateHasChanged();
    }
    private void BackToCategoryListMobile() {
        _mobileShowMaterialList = false;
        _selectedCategory = null;
        StateHasChanged();
    }
    private void BackToMaterialList() {
        _mobileShowEditor = false;
        _selectedMaterial = null;
        StateHasChanged();
    }
    private void ShowAddCategoryModal() {
        var categoryCount = _project?.ProjectDataObject?.Material?.Category?.Length ?? 0;
        _categoryModalTitle = $"カテゴリ{categoryCount + 1}";
        _isEditingCategory = false;
        _editingCategory = null;
        _showCategoryModal = true;
    }
    private void ShowRenameCategoryModal(MaterialCategory category) {
        _categoryModalTitle = category.Title;
        _isEditingCategory = true;
        _editingCategory = category;
        _showCategoryModal = true;
    }
    private void CloseCategoryModal() {
        _showCategoryModal = false;
        _categoryModalTitle = "";
        _isEditingCategory = false;
        _editingCategory = null;
    }
    private async Task HandleCategoryModalKeyDown(KeyboardEventArgs e) {
        if (e.Key == "Enter") {
            await SaveCategory();
        } else if (e.Key == "Escape") {
            CloseCategoryModal();
        }
    }
    private async Task SaveCategory() {
        if (string.IsNullOrWhiteSpace(_categoryModalTitle)) {
            return;
        }
        if (_isEditingCategory && _editingCategory != null) {
            _editingCategory.Title = _categoryModalTitle;
        } else {
            var newCategory = new MaterialCategory {
                Title = _categoryModalTitle,
                Items = Array.Empty<MaterialItem>()
            };
            var categories = _project.ProjectDataObject.Material.Category?.ToList() ?? new List<MaterialCategory>();
            categories.Add(newCategory);
            _project.ProjectDataObject.Material.Category = categories.ToArray();
        }
        await SaveProject();
        CloseCategoryModal();
        StateHasChanged();
    }
    private void ShowDeleteCategoryConfirm(MaterialCategory category) {
        _showDeleteCategoryConfirm = true;
        _editingCategory = category;
    }
    private void CloseDeleteCategoryConfirm() {
        _showDeleteCategoryConfirm = false;
        _editingCategory = null;
    }
    private async Task DeleteCategory() {
        if (_project.ProjectDataObject?.Material?.Category != null) {
            var categories = _project.ProjectDataObject.Material.Category.ToList();
            var category = _editingCategory;
            categories.Remove(category);
            _project.ProjectDataObject.Material.Category = categories.ToArray();
            if (_selectedCategory == category) {
                _selectedCategory = null;
                _selectedMaterial = null;
            }
            await SaveProject();
            CloseDeleteCategoryConfirm();
            StateHasChanged();
        }
    }
    private void ShowAddMaterialModal() {
        var itemCount = _selectedCategory?.Items?.Length ?? 0;
        _materialModalTitle = $"資料{itemCount + 1}";
        _isEditingMaterial = false;
        _editingMaterial = null;
        _showMaterialModal = true;
    }
    private void ShowRenameMaterialModal(MaterialItem material) {
        _materialModalTitle = material.Title;
        _isEditingMaterial = true;
        _editingMaterial = material;
        _showMaterialModal = true;
    }
    private void CloseMaterialModal() {
        _showMaterialModal = false;
        _materialModalTitle = "";
        _isEditingMaterial = false;
        _editingMaterial = null;
    }
    private async Task HandleMaterialModalKeyDown(KeyboardEventArgs e) {
        if (e.Key == "Enter") {
            await SaveMaterial();
        } else if (e.Key == "Escape") {
            CloseMaterialModal();
        }
    }
    private async Task SaveMaterial() {
        if (string.IsNullOrWhiteSpace(_materialModalTitle)) {
            return;
        }
        if (_isEditingMaterial && _editingMaterial != null) {
            _editingMaterial.Title = _materialModalTitle;
        } else {
            if (_selectedCategory != null) {
                var newMaterial = new MaterialItem {
                    Title = _materialModalTitle,
                    Text = ""
                };
                var items = _selectedCategory.Items?.ToList() ?? new List<MaterialItem>();
                items.Add(newMaterial);
                _selectedCategory.Items = items.ToArray();
                _selectedMaterial = newMaterial;
            }
        }
        await SaveProject();
        CloseMaterialModal();
        StateHasChanged();
    }
    private void ShowDeleteMaterialConfirm(MaterialItem material) {
        _showDeleteMaterialConfirm = true;
        _editingMaterial = material;
    }
    private void CloseDeleteMaterialConfirm() {
        _showDeleteMaterialConfirm = false;
        _editingMaterial = null;
    }
    private async Task DeleteMaterial() {
        if (_selectedCategory?.Items != null) {
            var items = _selectedCategory.Items.ToList();
            var material = _editingMaterial;
            items.Remove(material);
            _selectedCategory.Items = items.ToArray();
            if (_selectedMaterial == material) {
                _selectedMaterial = _selectedCategory.Items?.FirstOrDefault();
            }
            await SaveProject();
            CloseDeleteMaterialConfirm();
            StateHasChanged();
        }
    }
    private void ToggleSidebar() {
        _sidebarCollapsed = !_sidebarCollapsed;
    }
    private int _dragSourceIndex = -1;
    private int _dragOverIndex = -1;
    private bool _dragOverBottom = false;
    private void HandleDragStart(int index) {
        _dragSourceIndex = index;
    }
    private void HandleDragEnd() {
        _dragSourceIndex = -1;
        _dragOverIndex = -1;
        _dragOverBottom = false;
    }
    private void HandleDragOver(DragEventArgs e, int index) {
        _dragOverIndex = index;
        _dragOverBottom = e.OffsetY > 20;
    }
    private void HandleDragLeave() {
        _dragOverIndex = -1;
        _dragOverBottom = false;
    }
    private string GetDragClass(int index) {
        if (_dragSourceIndex == index) {
            return "dragging";
        }
        if (_dragOverIndex == index) {
            return _dragOverBottom ? "drag-over-bottom" : "drag-over-top";
        }
        return "";
    }
    private async Task HandleDrop(int targetIndex) {
        if (_dragSourceIndex == -1 || _dragSourceIndex == targetIndex) {
            HandleDragEnd();
            return;
        }
        if (_project?.ProjectDataObject?.Material?.Category == null) {
            HandleDragEnd();
            return;
        }
        var categories = _project.ProjectDataObject.Material.Category.ToList();
        var draggedCategory = categories[_dragSourceIndex];
        categories.RemoveAt(_dragSourceIndex);
        int insertIndex = targetIndex;
        if (_dragSourceIndex > targetIndex) {
            if (_dragOverBottom) {
                insertIndex++;
            }
        } else {
            insertIndex--;
            if (_dragOverBottom) {
                insertIndex++;
            }
        }
        if (insertIndex < 0) insertIndex = 0;
        if (insertIndex > categories.Count) insertIndex = categories.Count;
        categories.Insert(insertIndex, draggedCategory);
        _project.ProjectDataObject.Material.Category = categories.ToArray();
        await SaveProject();
        HandleDragEnd();
        StateHasChanged();
    }
    private int _dragSourceMaterialIndex = -1;
    private int _dragOverMaterialIndex = -1;
    private bool _dragOverMaterialBottom = false;
    private void HandleMaterialDragStart(int index) {
        _dragSourceMaterialIndex = index;
    }
    private void HandleMaterialDragEnd() {
        _dragSourceMaterialIndex = -1;
        _dragOverMaterialIndex = -1;
        _dragOverMaterialBottom = false;
    }
    private void HandleMaterialDragOver(DragEventArgs e, int index) {
        _dragOverMaterialIndex = index;
        _dragOverMaterialBottom = e.OffsetY > 20;
    }
    private void HandleMaterialDragLeave() {
        _dragOverMaterialIndex = -1;
        _dragOverMaterialBottom = false;
    }
    private string GetMaterialDragClass(int index) {
        if (_dragSourceMaterialIndex == index) {
            return "dragging";
        }
        if (_dragOverMaterialIndex == index) {
            return _dragOverMaterialBottom ? "drag-over-bottom" : "drag-over-top";
        }
        return "";
    }
    private async Task HandleMaterialDrop(int targetIndex) {
        if (_dragSourceMaterialIndex == -1 || _dragSourceMaterialIndex == targetIndex) {
            HandleMaterialDragEnd();
            return;
        }
        if (_selectedCategory?.Items == null) {
            HandleMaterialDragEnd();
            return;
        }
        var materials = _selectedCategory.Items.ToList();
        var draggedMaterial = materials[_dragSourceMaterialIndex];
        materials.RemoveAt(_dragSourceMaterialIndex);
        int insertIndex = targetIndex;
        if (_dragSourceMaterialIndex > targetIndex) {
            if (_dragOverMaterialBottom) {
                insertIndex++;
            }
        } else {
            insertIndex--;
            if (_dragOverMaterialBottom) {
                insertIndex++;
            }
        }
        if (insertIndex < 0) insertIndex = 0;
        if (insertIndex > materials.Count) insertIndex = materials.Count;
        materials.Insert(insertIndex, draggedMaterial);
        _selectedCategory.Items = materials.ToArray();
        await SaveProject();
        HandleMaterialDragEnd();
        StateHasChanged();
    }
}
<script>
    function adjustContainerHeight() {
        const topRow = document.querySelector('.top-row');
        const desktopContainer = document.querySelector('.edit-container.desktop-view');
        const mobileContainer = document.querySelector('.mobile-view');
        const mobileView = document.querySelector('.mobile-list');
        const mobileEditor = document.querySelector('.mobile-editor');
        if (topRow) {
            const isCollapsed = topRow.classList.contains('collapsed');
            const height = isCollapsed ? 'calc(100dvh - 2rem)' : 'calc(100dvh - 5.5rem)';
            if (desktopContainer) desktopContainer.style.height = height;
            if (mobileContainer) mobileContainer.style.height = height;
            if (mobileView) mobileView.style.height = height;
            if (mobileEditor) mobileEditor.style.height = height;
        }
    }
    window.adjustContainerHeight = adjustContainerHeight;
</script>