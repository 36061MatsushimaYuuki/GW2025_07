@page "/projects"

@rendermode InteractiveServer
@attribute [Authorize]

@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using StoryDesignSupportWebApp.Data
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext Db
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ProtectedSessionStorage SessionStorage
@inject IJSRuntime JSRuntime

<PageTitle>LunaStory - プロジェクト</PageTitle>

<style>
    .projects-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .search-filter-row {
        display: flex;
        gap: 10px;
        margin-bottom: 0;
        align-items: stretch;
    }

    .filter-button {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0;
        width: 44px;
        height: 44px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s;
        flex-shrink: 0;
    }

        .filter-button:hover {
            background: #5a6268;
        }

        .filter-button.active {
            background: #007bff;
        }

            .filter-button.active:hover {
                background: #0056b3;
            }

        .filter-button img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

    .search-box {
        flex: 1;
        min-width: 150px;
    }

        .search-box input {
            width: 100%;
            height: 44px;
            padding: 0 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

    .add-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 0;
        width: 44px;
        height: 44px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s;
        flex-shrink: 0;
    }

        .add-button:hover {
            background: #0056b3;
        }

    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

        .modal-overlay.show {
            display: flex;
        }

    .filter-modal-content {
        background: white;
        border-radius: 8px;
        padding: 25px;
        max-width: 450px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .filter-section {
        margin-bottom: 20px;
    }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-section h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #333;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

            .filter-section h4 .expand-icon {
                font-size: 12px;
                transition: transform 0.3s;
            }

                .filter-section h4 .expand-icon.expanded {
                    transform: rotate(90deg);
                }

    .sort-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .sort-select {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background: white;
        cursor: pointer;
    }

    .sort-order-btn {
        padding: 10px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s, border-color 0.2s;
        white-space: nowrap;
    }

        .sort-order-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .sort-order-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

    .genre-section-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

        .genre-section-content.expanded {
            max-height: 250px;
        }

    .genre-filter-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
    }

    .genre-filter-option {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .genre-filter-option input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .genre-filter-option label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            font-weight: normal;
        }

    .filter-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

        .filter-actions button {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

    .clear-filter-btn {
        background: #6c757d;
        color: white;
    }

        .clear-filter-btn:hover {
            background: #5a6268;
        }

    .apply-filter-btn {
        background: #30b84f;
        color: white;
    }

        .apply-filter-btn:hover {
            background: #269e41;
        }

    .modal-content {
        background: white;
        border-radius: 8px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: -10px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #eee;
    }

        .modal-header h3 {
            margin: 0;
            margin-left: -18px;
            color: #333;
        }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: -18px;
    }

        .modal-close:hover {
            color: #333;
        }

    .form-group {
        margin-bottom: 20px;
    }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

    .required {
        color: red;
    }

    .form-group input[type="text"],
    .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }

    .genre-input-container {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

        .genre-input-container input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

    .genre-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }

    .genre-tag-editable {
        background: #e9ecef;
        color: #495057;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

        .genre-tag-editable button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .genre-tag-editable button:hover {
                color: #a71d2a;
            }

    .genre-count {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 20px;
        border: 1px solid #f5c6cb;
        font-size: 14px;
    }

        .error-message ul {
            margin: 8px 0 0 0;
            padding-left: 20px;
        }

        .error-message li {
            margin-bottom: 4px;
        }

    .char-count {
        font-size: 12px;
        color: #666;
        text-align: right;
        margin-top: 4px;
    }

        .char-count.error {
            color: #dc3545;
            font-weight: bold;
        }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

        .modal-actions button {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

    .save-btn {
        background: #30b84f;
        color: white;
    }

        .save-btn:hover {
            background: #269e41;
        }

    .cancel-btn {
        background: #6c757d;
        color: white;
    }

        .cancel-btn:hover {
            background: #5a6268;
        }

    .projects-count {
        background: white;
        margin-left: 2px;
        margin-bottom: 10px;
        font-size: 14px;
        color: #666;
    }

        .projects-count strong {
            color: #007bff;
            font-size: 16px;
        }

    .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }

    .project-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        height: 280px;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        position: relative;
    }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
    }

    .project-name {
        font-size: 22px;
        font-weight: bold;
        color: #333;
        margin: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
        margin-right: 10px;
    }

    .project-actions {
        display: flex;
        gap: 5px;
    }

        .project-actions button {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
            z-index: 10;
        }

    .edit-btn {
        background: #17a2b8;
        color: white;
    }

        .edit-btn:hover {
            background: #138496;
        }

    .delete-btn {
        background: #dc3545;
        color: white;
    }

        .delete-btn:hover {
            background: #c82333;
        }

    .delete-modal-content {
        background: white;
        border-radius: 8px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .delete-modal-message {
        margin-bottom: 20px;
        font-size: 16px;
        color: #333;
    }

    .delete-modal-project-name {
        font-weight: bold;
        font-size: 18px;
        color: #dc3545;
        margin: 10px 0;
    }

    .delete-modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

        .delete-modal-actions button {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

    .delete-confirm-btn {
        background: #dc3545;
        color: white;
    }

        .delete-confirm-btn:hover {
            background: #c82333;
        }

    .project-overview {
        color: #666;
        font-size: 14px;
        margin-bottom: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 5;
        -webkit-box-orient: vertical;
        line-height: 1.5;
        height: 105px;
        flex-shrink: 0;
    }

    .project-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .project-genres-compact {
        font-size: 12px;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }

        .project-genres-compact span {
            color: #007bff;
        }

    .project-dates {
        padding-top: 12px;
        border-top: 1px solid #eee;
        font-size: 12px;
        color: #666;
    }

        .project-dates div {
            margin-bottom: 4px;
        }

    .no-projects {
        text-align: center;
        padding: 60px 20px;
        color: #666;
        font-size: 16px;
    }

    .loading {
        text-align: center;
        padding: 60px 20px;
        color: #666;
        font-size: 16px;
    }

    .project-add-button {
        border: none;
        position: sticky;
        bottom: 3%;
        left: 95%;
        width: 56px;
        height: 56px;
        border-radius: 100%;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        background-color: #007bff;
        font-size: 24px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
        z-index: 100;
    }

        .project-add-button:hover {
            background: #0056b3;
        }

        .project-add-button.show {
            opacity: 1;
            visibility: visible;
        }
</style>

<div class="projects-container">
    <div class="header-section">
        <h3 style="margin-top: 0;">プロジェクト一覧</h3>

        <div class="search-filter-row">
            <button class="filter-button @(HasActiveFilters ? "active" : "")"
                    @onclick="OpenFilterModal"
                    title="ソート・フィルター">
                <img src="/images/filter-icon.png" />
            </button>

            <div class="search-box">
                <input type="text"
                       @bind="searchText"
                       @bind:event="oninput"
                       placeholder="プロジェクトを検索..." />
            </div>

            <button class="add-button" @onclick="OpenAddModal" title="新規プロジェクト">
                +
            </button>
        </div>
    </div>

    @if (_projects == null) {
        <div class="loading">
            読み込み中...
        </div>
    } else if (!FilteredProjects.Any()) {
        <div class="no-projects">
            @if (!string.IsNullOrWhiteSpace(searchText) || HasActiveFilters) {
                <p>検索条件に一致するプロジェクトが見つかりません。</p>
            } else {
                <p>プロジェクトがありません。新しいプロジェクトを作成してください。</p>
            }
        </div>
    } else {
        @if (_projects != null && _projects.Any()) {
            <div class="projects-count">
                @if (HasSearchOrGenreFilter) {
                    <span>検索結果: <strong>@FilteredProjects.Count()</strong>件 / 総件数: @_projects.Count 件</span>
                } else {
                    <span>総件数: <strong>@_projects.Count</strong>件</span>
                }
            </div>
        }

        <div class="projects-grid">
            @foreach (var p in FilteredProjects) {
                <div class="project-card" @onclick="() => NavigateToEdit(p.Id)">
                    <div class="project-header">
                        <h4 class="project-name" title="@p.Name">@p.Name</h4>
                        <div class="project-actions">
                            <button class="edit-btn" @onclick:stopPropagation="true" @onclick="() => OpenEditModal(p)">編集</button>
                            <button class="delete-btn" @onclick:stopPropagation="true" @onclick="() => OpenDeleteModal(p.Id, p.Name)">削除</button>
                        </div>
                    </div>

                    <div class="project-overview">
                        @(string.IsNullOrWhiteSpace(p.Overview) ? "概要なし" : p.Overview)
                    </div>

                    <div class="project-meta">
                        <div class="project-genres-compact">
                            @if (p.Genre != null && p.Genre.Any(g => !string.IsNullOrWhiteSpace(g))) {
                                <span>@string.Join(", ", p.Genre.Where(g => !string.IsNullOrWhiteSpace(g)))</span>
                            } else {
                                <span style="color: #999;">ジャンルなし</span>
                            }
                        </div>
                    </div>

                    <div class="project-dates">
                        <div>作成日: @ToLocalTime(p.CreatedAt).ToString("yyyy/MM/dd HH:mm")</div>
                        <div>更新日: @GetRelativeTime(p.UpdatedAt)</div>
                    </div>
                </div>
            }
        </div>

        <button class="project-add-button @(isVisible ? "show" : "")" @onclick="OpenAddModal">+</button>
    }
</div>

<!-- ソート・フィルターモーダル -->
<div class="modal-overlay @(showFilterModal ? "show" : "")" @onclick="CloseFilterModalOnOverlay">
    <div class="filter-modal-content" @onclick:stopPropagation="true">
        <div class="modal-header">
            <h3>ソート・フィルター</h3>
            <button class="modal-close" @onclick="CloseFilterModal">&times;</button>
        </div>

        <div class="filter-section">
            <h4>並び順</h4>
            <div class="sort-controls">
                <select class="sort-select" @bind="sortField">
                    <option value="created">作成日</option>
                    <option value="updated">更新日</option>
                </select>
                <button class="sort-order-btn @(sortOrder == "desc" ? "active" : "")"
                        @onclick="@(() => sortOrder = "desc")">
                    新しい順
                </button>
                <button class="sort-order-btn @(sortOrder == "asc" ? "active" : "")"
                        @onclick="@(() => sortOrder = "asc")">
                    古い順
                </button>
            </div>
        </div>

        <div class="filter-section">
            <h4 @onclick="ToggleGenreSection">
                <span class="expand-icon @(genreSectionExpanded ? "expanded" : "")">▶</span>
                ジャンル
            </h4>
            <div class="genre-section-content @(genreSectionExpanded ? "expanded" : "")">
                @if (GetAllGenres().Any()) {
                    <div class="genre-filter-list">
                        @foreach (var genre in GetAllGenres()) {
                            <div class="genre-filter-option">
                                <input type="checkbox"
                                       id="genre-@genre"
                                       checked="@selectedGenreFilters.Contains(genre)"
                                       @onchange="@(() => ToggleGenreFilter(genre))" />
                                <label for="genre-@genre">@genre (@GetGenreCount(genre))</label>
                            </div>
                        }
                    </div>
                } else {
                    <p style="color: #666; font-size: 14px; margin: 10px 0 0 0;">ジャンルがありません</p>
                }
            </div>
        </div>

        <div class="filter-actions">
            <button class="clear-filter-btn" @onclick="ClearFilters">クリア</button>
            <button class="apply-filter-btn" @onclick="ApplyFilters">適用</button>
        </div>
    </div>
</div>

<!-- 新規追加/編集モーダル -->
<div class="modal-overlay @(showModal ? "show" : "")" @onclick="CloseModalOnOverlay">
    <div class="modal-content" @onclick:stopPropagation="true">
        <div class="modal-header">
            <h3>@(isEditMode ? "プロジェクトを編集" : "新規プロジェクト")</h3>
            <button class="modal-close" @onclick="CloseModal">&times;</button>
        </div>

        @if (validationErrors.Any()) {
            <div class="error-message">
                <strong>エラー:</strong>
                <ul>
                    @foreach (var error in validationErrors) {
                        <li>@error</li>
                    }
                </ul>
            </div>
        }

        <div class="form-group">
            <label>プロジェクト名 <span class="required">*</span></label>
            <input type="text"
                   @bind="modalProjectName"
                   @bind:event="oninput"
                   placeholder="プロジェクト名を入力"
                   maxlength="100" />
            <div class="char-count @(modalProjectName.Length > 100 ? "error" : "")">
                @modalProjectName.Length / 100
            </div>
        </div>

        <div class="form-group">
            <label>概要</label>
            <textarea @bind="modalProjectOverview"
                      @bind:event="oninput"
                      placeholder="プロジェクトの概要を入力"
                      maxlength="200"></textarea>
            <div class="char-count @(modalProjectOverview.Length > 200 ? "error" : "")">
                @modalProjectOverview.Length / 200
            </div>
        </div>

        <div class="form-group">
            <label>ジャンル (最大5個)</label>
            <div class="genre-input-container">
                <input type="text"
                       @bind="genreInput"
                       @bind:event="oninput"
                       @onkeydown="HandleGenreInput"
                       placeholder="ジャンルを入力してスペースまたはEnterキーで追加"
                       maxlength="25"
                       disabled="@(modalGenres.Count >= Project.MaxGenreSize)" />
            </div>
            <div class="char-count @(genreInput.Length > 25 ? "error" : "")">
                @genreInput.Length / 25
            </div>
            <div class="genre-count">@modalGenres.Count / @Project.MaxGenreSize</div>
            @if (modalGenres.Any()) {
                <div class="genre-tags">
                    @foreach (var genre in modalGenres) {
                        <div class="genre-tag-editable">
                            <span>@genre</span>
                            <button @onclick="() => RemoveGenre(genre)">×</button>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="modal-actions">
            <button class="cancel-btn" @onclick="CloseModal">キャンセル</button>
            <button class="save-btn" @onclick="SaveProject">保存</button>
        </div>
    </div>
</div>

<!-- 削除確認モーダル -->
<div class="modal-overlay @(showDeleteModal ? "show" : "")" @onclick="CloseDeleteModal">
    <div class="delete-modal-content" @onclick:stopPropagation="true">
        <div class="modal-header">
            <h3>プロジェクトの削除</h3>
            <button class="modal-close" @onclick="CloseDeleteModal">&times;</button>
        </div>

        <div class="delete-modal-message">
            以下のプロジェクトを削除してもよろしいですか？
            <div class="delete-modal-project-name">@deleteTargetProjectName</div>
            この操作は取り消せません。
        </div>

        <div class="delete-modal-actions">
            <button class="cancel-btn" @onclick="CloseDeleteModal">キャンセル</button>
            <button class="delete-confirm-btn" @onclick="ConfirmDelete">削除</button>
        </div>
    </div>
</div>

@code {
    private List<ProjectListItem>? _projects;
    private string searchText = "";
    private string? userId;

    // プロジェクト一覧用の軽量データ構造
    private class ProjectListItem {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string? Overview { get; set; }
        public string[]? Genre { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
    }

    // ソート・フィルター関連
    private bool showFilterModal = false;
    private string sortField = "created";
    private string sortOrder = "desc";
    private HashSet<string> selectedGenreFilters = new();
    private bool genreSectionExpanded = false;

    private bool HasActiveFilters => !(sortField == "created" && sortOrder == "desc") || selectedGenreFilters.Any();

    private bool HasSearchOrGenreFilter => !string.IsNullOrWhiteSpace(searchText) || selectedGenreFilters.Any();

    // モーダル関連
    private bool showModal = false;
    private bool isEditMode = false;
    private int? editingProjectId = null;
    private string modalProjectName = "";
    private string modalProjectOverview = "";
    private List<string> modalGenres = new();
    private string genreInput = "";
    private List<string> validationErrors = new();

    // 削除確認モーダル関連
    private bool showDeleteModal = false;
    private int? deleteTargetId = null;
    private string deleteTargetProjectName = "";

    private bool isVisible = false;
    private DotNetObjectReference<Projects>? _dotNetHelper;

    private TimeZoneInfo? _clientTimeZone;

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            _dotNetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("initializeScrollListener", _dotNetHelper);
            try {
                var tzId = await JSRuntime.InvokeAsync<string>(
                    "eval", "Intl.DateTimeFormat().resolvedOptions().timeZone");
                _clientTimeZone = TimeZoneInfo.FindSystemTimeZoneById(tzId);
            }
            catch {
                _clientTimeZone = TimeZoneInfo.Utc;
            }
            StateHasChanged();

            // 初期スクロール位置をチェック
            await Task.Delay(100); // DOMの準備を待つ
            try {
                var scrollY = await JSRuntime.InvokeAsync<double>("eval", "window.scrollY || window.pageYOffset");
                OnScrollPositionChanged(scrollY);
            }
            catch {
                // エラーは無視
            }
        }
    }

    private DateTime ToLocalTime(DateTime utc) {
        if (_clientTimeZone == null) return utc;
        return TimeZoneInfo.ConvertTimeFromUtc(utc, _clientTimeZone);
    }

    public void Dispose() {
        _dotNetHelper?.Dispose();
    }

    private IEnumerable<ProjectListItem> FilteredProjects {
        get {
            if (_projects == null) return Enumerable.Empty<ProjectListItem>();

            var filtered = _projects.AsEnumerable();

            // 検索フィルター
            if (!string.IsNullOrWhiteSpace(searchText)) {
                filtered = filtered.Where(p =>
                    p.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    (p.Overview != null && p.Overview.Contains(searchText, StringComparison.OrdinalIgnoreCase)));
            }

            // ジャンルフィルター
            if (selectedGenreFilters.Any()) {
                filtered = filtered.Where(p =>
                    p.Genre != null && p.Genre.Any(g => selectedGenreFilters.Contains(g)));
            }

            // ソート適用
            if (sortField == "created") {
                filtered = sortOrder == "desc"
                    ? filtered.OrderByDescending(p => p.CreatedAt)
                    : filtered.OrderBy(p => p.CreatedAt);
            } else {
                filtered = sortOrder == "desc"
                    ? filtered.OrderByDescending(p => p.UpdatedAt ?? p.CreatedAt)
                    : filtered.OrderBy(p => p.UpdatedAt ?? p.CreatedAt);
            }

            return filtered;
        }
    }

    private IEnumerable<string> GetAllGenres() {
        if (_projects == null) return Enumerable.Empty<string>();

        return _projects
            .Where(p => p.Genre != null)
            .SelectMany(p => p.Genre!)
            .Where(g => !string.IsNullOrWhiteSpace(g))
            .Distinct()
            .OrderBy(g => g);
    }

    protected override async Task OnInitializedAsync() {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var appUser = await UserManager.GetUserAsync(user);
        userId = appUser?.Id;

        // ProjectDataObjectを除外して必要なフィールドのみ取得
        _projects = await Db.Projects
            .AsNoTracking()
            .Where(x => x.UserId == userId)
            .Select(p => new ProjectListItem {
                Id = p.Id,
                Name = p.Name,
                Overview = p.Overview,
                Genre = p.Genre,
                CreatedAt = p.CreatedAt,
                UpdatedAt = p.UpdatedAt
            })
            .ToListAsync();

        isVisible = false;
    }

    // ソート・フィルターモーダル
    private void OpenFilterModal() {
        showFilterModal = true;
    }

    private void CloseFilterModal() {
        showFilterModal = false;
    }

    private void CloseFilterModalOnOverlay(MouseEventArgs e) {
        CloseFilterModal();
    }

    private void ToggleGenreFilter(string genre) {
        if (selectedGenreFilters.Contains(genre)) {
            selectedGenreFilters.Remove(genre);
        } else {
            selectedGenreFilters.Add(genre);
        }
    }

    private void ToggleGenreSection() {
        genreSectionExpanded = !genreSectionExpanded;
    }

    private int GetGenreCount(string genre) {
        if (_projects == null) return 0;

        return _projects.Count(p => p.Genre != null && p.Genre.Contains(genre));
    }

    private void ClearFilters() {
        sortField = "created";
        sortOrder = "desc";
        selectedGenreFilters.Clear();
    }

    private void ApplyFilters() {
        CloseFilterModal();
    }

    // プロジェクト編集モーダル
    private void OpenAddModal() {
        isEditMode = false;
        editingProjectId = null;
        modalProjectName = "";
        modalProjectOverview = "";
        modalGenres.Clear();
        genreInput = "";
        validationErrors.Clear();
        showModal = true;
    }

    private async Task OpenEditModal(ProjectListItem projectItem) {
        // 編集時のみ完全なプロジェクトデータを取得
        var project = await Db.Projects
            .AsNoTracking()
            .Where(x => x.Id == projectItem.Id && x.UserId == userId)
            .FirstOrDefaultAsync();

        if (project == null) return;

        isEditMode = true;
        editingProjectId = project.Id;
        modalProjectName = project.Name;
        modalProjectOverview = project.Overview ?? "";
        modalGenres = project.Genre?.Where(g => !string.IsNullOrWhiteSpace(g)).ToList() ?? new();
        genreInput = "";
        validationErrors.Clear();
        showModal = true;
    }

    private void CloseModal() {
        showModal = false;
        validationErrors.Clear();
    }

    private void CloseModalOnOverlay(MouseEventArgs e) {
        CloseModal();
    }

    private void HandleGenreInput(KeyboardEventArgs e) {
        if ((e.Key == " " || e.Key == "Enter") && !string.IsNullOrWhiteSpace(genreInput)) {
            AddGenre();
        }
    }

    private void AddGenre() {
        var trimmedGenre = genreInput.Trim();

        if (string.IsNullOrWhiteSpace(trimmedGenre)) {
            genreInput = "";
            return;
        }

        if (trimmedGenre.Length > 25) {
            validationErrors.Clear();
            validationErrors.Add("ジャンルは25文字以内で入力してください。");
            return;
        }

        if (modalGenres.Count >= Project.MaxGenreSize) {
            validationErrors.Clear();
            validationErrors.Add("ジャンルは最大5個までです。");
            genreInput = "";
            return;
        }

        if (modalGenres.Contains(trimmedGenre)) {
            validationErrors.Clear();
            validationErrors.Add("このジャンルは既に追加されています。");
            genreInput = "";
            return;
        }

        modalGenres.Add(trimmedGenre);
        genreInput = "";
        validationErrors.Clear();
    }

    private void RemoveGenre(string genre) {
        modalGenres.Remove(genre);
    }

    private async Task SaveProject() {
        // バリデーション
        validationErrors.Clear();

        if (string.IsNullOrWhiteSpace(modalProjectName)) {
            validationErrors.Add("プロジェクト名は必須です。");
        } else if (modalProjectName.Length > 100) {
            validationErrors.Add("プロジェクト名は100文字以内で入力してください。");
        }

        if (modalProjectOverview.Length > 200) {
            validationErrors.Add("概要は200文字以内で入力してください。");
        }

        // ジャンル入力中のテキストがあればバリデーション
        if (!string.IsNullOrWhiteSpace(genreInput)) {
            if (genreInput.Trim().Length > 25) {
                validationErrors.Add("入力中のジャンルは25文字以内で入力してください。");
            } else {
                // 自動的に追加
                AddGenre();
            }
        }

        // 各ジャンルの長さをチェック
        foreach (var genre in modalGenres) {
            if (genre.Length > 25) {
                validationErrors.Add($"ジャンル「{genre}」は25文字以内にしてください。");
            }
        }

        if (validationErrors.Any()) {
            return;
        }

        if (isEditMode && editingProjectId.HasValue) {
            // 編集モード - ProjectDataObjectを含む完全なエンティティを取得
            var project = await Db.Projects
                .Where(x => x.Id == editingProjectId.Value && x.UserId == userId)
                .FirstOrDefaultAsync();

            if (project != null) {
                project.Name = modalProjectName;
                project.Overview = modalProjectOverview;
                project.Genre = modalGenres.Any() ? modalGenres.ToArray() : null;
                project.UpdatedAt = DateTime.UtcNow;

                await Db.SaveChangesAsync();

                // リストアイテムを更新
                var index = _projects!.FindIndex(p => p.Id == editingProjectId.Value);
                if (index >= 0) {
                    _projects[index] = new ProjectListItem {
                        Id = project.Id,
                        Name = project.Name,
                        Overview = project.Overview,
                        Genre = project.Genre,
                        CreatedAt = project.CreatedAt,
                        UpdatedAt = project.UpdatedAt
                    };
                }
            }
        } else {
            // 新規追加モード
            var project = new Project() {
                Name = modalProjectName,
                Overview = modalProjectOverview,
                Genre = modalGenres.Any() ? modalGenres.ToArray() : null,
                UserId = userId!,
                CreatedAt = DateTime.UtcNow
            };

            Db.Projects.Add(project);
            await Db.SaveChangesAsync();

            // リストに追加
            _projects!.Insert(0, new ProjectListItem {
                Id = project.Id,
                Name = project.Name,
                Overview = project.Overview,
                Genre = project.Genre,
                CreatedAt = project.CreatedAt,
                UpdatedAt = project.UpdatedAt
            });
        }

        CloseModal();
    }

    private async Task NavigateToEdit(int id) {
        // フラグを設定
        await SessionStorage.SetAsync("fromProjectsList", true);
        Nav.NavigateTo($"/projects/edit/{id}");
    }

    private void OpenDeleteModal(int id, string projectName) {
        deleteTargetId = id;
        deleteTargetProjectName = projectName;
        showDeleteModal = true;
    }

    private void CloseDeleteModal() {
        showDeleteModal = false;
        deleteTargetId = null;
        deleteTargetProjectName = "";
    }

    private async Task ConfirmDelete() {
        if (deleteTargetId.HasValue) {
            var target = await Db.Projects
                .Where(x => x.Id == deleteTargetId.Value && x.UserId == userId)
                .FirstOrDefaultAsync();

            if (target != null) {
                Db.Projects.Remove(target);
                await Db.SaveChangesAsync();

                if (_projects != null) {
                    var itemToRemove = _projects.FirstOrDefault(p => p.Id == deleteTargetId.Value);
                    if (itemToRemove != null) {
                        _projects.Remove(itemToRemove);
                    }
                }
            }
        }
        CloseDeleteModal();
    }

    private string GetRelativeTime(DateTime? dateTime) {
        if (!dateTime.HasValue) return "未更新";

        var localTime = ToLocalTime(dateTime.Value);
        var now = ToLocalTime(DateTime.UtcNow);
        var diff = now - localTime;

        if (diff.TotalMinutes < 1) return "たった今";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}分前";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}時間前";
        if (diff.TotalDays < 30) return $"{(int)diff.TotalDays}日前";
        if (diff.TotalDays < 365) return $"{(int)(diff.TotalDays / 30)}ヶ月前";
        return $"{(int)(diff.TotalDays / 365)}年前";
    }

    [JSInvokable("OnScrollPositionChanged")]
    public void OnScrollPositionChanged(double scrollY) {
        // 300px以上スクロールしたら表示
        bool newVisibility = scrollY > 190;
        if (isVisible != newVisibility) {
            isVisible = newVisibility;
            InvokeAsync(StateHasChanged); // InvokeAsyncでラップ
        }
    }
}

<script>
    window.initializeScrollListener = function(dotNetHelper) {
        // 既存のリスナーをクリーンアップ
        if (window.scrollListenerHandler) {
            window.removeEventListener('scroll', window.scrollListenerHandler);
        }

        window.scrollListenerHandler = function() {
            const scrollY = window.scrollY || window.pageYOffset;

            try {
                dotNetHelper.invokeMethodAsync('OnScrollPositionChanged', scrollY);
            } catch (err) {
                console.warn('Scroll listener failed:', err);
            }
        };

        window.addEventListener('scroll', window.scrollListenerHandler);

        // 初期状態を即座にチェック
        setTimeout(() => {
            const scrollY = window.scrollY || window.pageYOffset;
            try {
                dotNetHelper.invokeMethodAsync('OnScrollPositionChanged', scrollY);
            } catch (err) {
                console.warn('Initial scroll check failed:', err);
            }
        }, 100);
    };
</script>