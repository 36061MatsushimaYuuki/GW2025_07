@page "/projects/edit/{id:int}/characters"

@rendermode InteractiveServer
@attribute [Authorize]

@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using StoryDesignSupportWebApp.Data
@using StoryDesignSupportWebApp.Data.EditData
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject UserManager<ApplicationUser> UserManager
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@inject ProtectedSessionStorage SessionStorage

<PageTitle>LunaStory - 人物</PageTitle>

<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html, body {
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden;
        background-color: #F3F6FB;
        font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    }

    body {
        overflow: hidden;
    }

    .edit-container {
        display: flex;
        height: calc(100vh - 5.5rem);
        overflow: hidden;
        max-width: 100vw;
        transition: height 0.3s ease;
    }

    /* サイドバー */
    .sidebar {
        width: 300px;
        background-color: #FAFCFF;
        border-right: 1px solid rgba(25, 118, 210, 0.12);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        position: relative;
        transition: margin-left 0.3s ease;
        box-shadow: 2px 0 12px rgba(25, 118, 210, 0.08);
    }

        .sidebar.collapsed {
            margin-left: -300px;
            width: 300px;
        }

    .sidebar-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(0,0,0,0.08);
        background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        cursor: pointer;
        color: white;
        font-weight: 600;
        font-size: 14px;
        letter-spacing: 0.5px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 6px rgba(25, 118, 210, 0.3);
    }

        .sidebar-header:hover {
            background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.4);
        }

    .sidebar-toggle {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background-color: #0969da;
        color: white;
        border: none;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        z-index: 10;
        box-shadow: 0 3px 10px rgba(9, 105, 218, 0.25);
        transition: all 0.2s ease;
    }

        .sidebar-toggle:hover {
            background-color: #0550ae;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(9, 105, 218, 0.35);
        }

    .sidebar-open-btn {
        position: fixed;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        background-color: #0969da;
        color: white;
        border: none;
        border-radius: 0 8px 8px 0;
        width: 36px;
        height: 56px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        z-index: 10;
        box-shadow: 3px 0 10px rgba(9, 105, 218, 0.25);
        transition: all 0.2s ease;
    }

        .sidebar-open-btn:hover {
            background-color: #0550ae;
            transform: translateY(-50%);
            box-shadow: 3px 0 15px rgba(9, 105, 218, 0.35);
        }

    .category-view, .character-view {
        flex: 1;
        overflow-y: auto;
    }

    .category-item {
        padding: 16px 20px;
        height: 60px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #FFFFFF;
        border-bottom: 1px solid rgba(0,0,0,0.06);
        border-left: 3px solid transparent;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

        .category-item:hover {
            background-color: #E3F2FD;
            border-left-color: #1976D2;
        }

        .category-item.active {
            background-color: #BBDEFB;
            color: #1565C0;
            border-left-color: #1976D2;
            font-weight: 600;
        }

        .category-item.dragging {
            opacity: 0.6;
            background-color: #f6f8fa;
        }

        .category-item.drag-over-top {
            border-top: 3px solid #1976D2;
            background-color: #E3F2FD;
        }

        .category-item.drag-over-bottom {
            border-bottom: 3px solid #1976D2;
            background-color: #E3F2FD;
        }

    .category-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .category-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .category-count {
        color: #656d76;
        font-size: 13px;
        font-weight: 400;
        flex-shrink: 0;
    }

    .category-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .category-item:hover .category-actions {
        opacity: 1;
    }

    .icon-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        font-size: 14px;
        padding: 4px;
        transition: color 0.2s ease;
    }

        .icon-btn:hover {
            color: #333;
        }

        .icon-btn.delete {
            background: none;
            padding: 0 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #ff2222;
            font-weight: bold;
        }

            .icon-btn.delete:hover {
                color: #ff1111;
            }

    .add-category-btn, .add-character-btn {
        margin: 16px;
        padding: 10px 16px;
        background: linear-gradient(135deg, #1976D2, #1565C0);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        letter-spacing: 0.3px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.25);
    }

        .add-category-btn:hover, .add-character-btn:hover {
            background: linear-gradient(135deg, #1565C0, #0D47A1);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(25, 118, 210, 0.35);
        }

        .add-category-btn.mobile, .add-character-btn.mobile {
            padding: 0px;
            height: 48px;
            width: 48px;
            font-size: 20px;
            text-align: center;
        }

    .character-item {
        padding: 16px 20px;
        height: 60px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #FFFFFF;
        border-bottom: 1px solid rgba(0,0,0,0.06);
        border-left: 3px solid transparent;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

        .character-item:hover {
            background-color: #E3F2FD;
            border-left-color: #1976D2;
        }

        .character-item.active {
            background-color: #BBDEFB;
            color: #1565C0;
            border-left-color: #1976D2;
            font-weight: 600;
        }

        .character-item.dragging {
            opacity: 0.6;
            background-color: #f6f8fa;
        }

        .character-item.drag-over-top {
            border-top: 3px solid #1976D2;
            background-color: #E3F2FD;
        }

        .character-item.drag-over-bottom {
            border-bottom: 3px solid #1976D2;
            background-color: #E3F2FD;
        }

    .character-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .character-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .character-item:hover .character-actions {
        opacity: 1;
    }

    .character-list-panel {
        width: 300px;
        background-color: #fafbfc;
        border-right: 1px solid #e1e4e8;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        position: relative;
        transition: margin-left 0.3s ease;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.04);
    }

    .character-list-header {
        padding: 15px;
        border-bottom: 1px solid #e1e4e8;
        background-color: #f6f8fa;
        color: white;
        font-weight: 600;
        transition: all 0.2s ease;
        color: #24292f;
        font-size: 16px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .character-thumbnail {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
        border: 1px solid #e1e4e8;
    }

    .character-thumbnail-placeholder {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: #e1e4e8;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: #8c959f;
    }

    .character-item-info {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-left: 10px;
    }

    .character-item-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 14px;
    }

    .character-item-ruby {
        font-size: 11px;
        color: #8c959f;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* エディタエリア */
    .editor-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #F8FAFF;
        overflow: hidden;
    }

    .editor-header {
        padding: 10px 15px;
        border-bottom: 1px solid #e1e4e8;
        background-color: #f6f8fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .editor-title {
        font-size: 24px;
        font-weight: 600;
        color: #24292f;
    }

    .editor-content {
        flex: 1;
        overflow-y: auto;
        padding: 30px 30px 20px 30px;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #8c959f;
        font-size: 16px;
    }

        .empty-state.category-bar {
            padding: 16px 20px;
            height: 60px;
            border-bottom: 1px solid #e1e4e8;
            justify-content: center;
            align-items: center;
        }

        .empty-state.character-bar {
            padding: 16px 20px;
            height: 60px;
            border-bottom: 1px solid #e1e4e8;
            justify-content: center;
            align-items: center;
        }

    .character-editor-layout {
        display: flex;
        gap: 24px;
        margin-bottom: 20px;
    }

    .character-image-section {
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .image-square {
        width: 300px;
        height: 300px;
        border: 2px dashed #d0d7de;
        border-radius: 8px;
        background-color: #f6f8fa;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        transition: border-color 0.2s ease;
    }

        .image-square img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

    .image-square-placeholder {
        color: #8c959f;
        font-size: 13px;
        text-align: center;
        line-height: 1.6;
    }

    .image-upload-label {
        display: block;
        padding: 5px 12px;
        background-color: #f6f8fa;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        color: #24292f;
        transition: background-color 0.2s ease;
        width: 100%;
        text-align: center;
    }

        .image-upload-label:hover {
            background-color: #e1e4e8;
        }

    .image-clear-btn {
        padding: 5px 12px;
        background-color: #fff0f0;
        border: 1px solid #ffb3b3;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        color: #dc3545;
        transition: background-color 0.2s ease;
        width: 100%;
    }

        .image-clear-btn:hover {
            background-color: #ffe0e0;
        }

    .character-fields-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .field-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

        .field-group label {
            font-size: 13px;
            font-weight: 600;
            color: #57606a;
        }

    .field-input {
        padding: 8px 10px;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.2s ease;
    }

        .field-input:focus {
            border-color: #0969da;
            box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
        }

    .field-row {
        display: flex;
        gap: 12px;
    }

        .field-row .field-group {
            flex: 1;
        }

    .overview-section {
        margin-top: 4px;
    }

    .overview-section {
        margin-top: 4px;
    }

    .overview-toolbar {
        display: flex;
        gap: 6px;
        padding: 6px 10px;
        background-color: #f0f4f8;
        border: 1px solid #d0d7de;
        border-bottom: none;
        border-radius: 6px 6px 0 0;
    }

    .toolbar-btn {
        padding: 3px 10px;
        background-color: white;
        border: 1px solid #d0d7de;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 700;
        line-height: 1.4;
        height: 32px;
        transition: all 0.15s ease;
        user-select: none;
    }

        .toolbar-btn:hover {
            background-color: #ddf4ff;
            border-color: #0969da;
            color: #0969da;
        }

    .overview-editor-wrap {
        border: 1px solid #d0d7de;
        border-radius: 0 0 6px 6px;
        min-height: 280px;
        position: relative;
        padding: 12px;
        outline: none;
        font-family: inherit;
        font-size: 15px;
        line-height: 1.8;
        cursor: text;
        background-color: white;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

        .overview-editor-wrap h1 {
            font-size: 1.4em;
            font-weight: 700;
            margin: 10px 0 4px 0;
            padding-bottom: 4px;
            border-bottom: 2px solid #e1e4e8;
            line-height: 1.4;
        }

        .overview-editor-wrap h2 {
            font-size: 1.2em;
            font-weight: 600;
            margin: 8px 0 3px 0;
            padding-bottom: 3px;
            border-bottom: 1px solid #e1e4e8;
            line-height: 1.4;
        }

        .overview-editor-wrap h3 {
            font-size: 1.05em;
            font-weight: 600;
            margin: 6px 0 2px 0;
            line-height: 1.4;
        }

        .overview-editor-wrap p {
            margin: 0 0 4px 0;
            line-height: 1.8;
        }

    /* モーダル */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .modal-content {
        background: #ffffff;
        border-radius: 16px;
        padding: 24px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18), 0 2px 8px rgba(25, 118, 210, 0.08);
        animation: slideUp 0.3s ease;
    }

    @@keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #24292f;
    }

    .modal-body {
        margin-bottom: 20px;
    }

    .modal-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid rgba(25, 118, 210, 0.25);
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s ease;
    }

        .modal-input:focus {
            border-color: #1976D2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.12);
        }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .modal-btn-cancel {
        background-color: #f6f8fa;
        color: #24292f;
    }

        .modal-btn-cancel:hover {
            background-color: #e1e4e8;
        }

    .modal-btn-primary {
        color: white;
        background: linear-gradient(135deg, #1976D2, #1565C0);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(25, 118, 210, 0.3);
    }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #1565C0, #0D47A1);
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.4);
        }

    .modal-btn-danger {
        background-color: #dc3545;
        color: white;
    }

        .modal-btn-danger:hover {
            background-color: #c82333;
        }

    .modal-btn-secondary {
        background-color: #6c757d;
        color: white;
    }

        .modal-btn-secondary:hover {
            background-color: #5a6268;
        }

    /* 画像トリミングモーダル */
    .crop-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        animation: fadeIn 0.2s ease;
    }

    .crop-modal-content {
        background: #1e1e2e;
        border-radius: 12px;
        padding: 24px;
        width: 92vw;
        max-width: 560px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.3s ease;
    }

    .crop-modal-title {
        color: white;
        font-size: 16px;
        font-weight: 600;
        align-self: flex-start;
    }

    .crop-viewport {
        position: relative;
        width: 100%;
        max-width: 500px;
        aspect-ratio: 1 / 1;
        overflow: hidden;
        border-radius: 8px;
        background-color: #111;
        cursor: move;
        touch-action: none;
    }

    .crop-image {
        position: absolute;
        transform-origin: center center;
        user-select: none;
        -webkit-user-drag: none;
        pointer-events: none;
    }

    .crop-grid {
        position: absolute;
        inset: 0;
        pointer-events: none;
        background-image: linear-gradient(rgba(255,255,255,0.15) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.15) 1px, transparent 1px);
        background-size: 33.33% 33.33%;
        border: 2px solid rgba(255,255,255,0.4);
    }

    .crop-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
    }

        .crop-controls label {
            color: #ccc;
            font-size: 13px;
            white-space: nowrap;
        }

    .crop-slider {
        flex: 1;
        accent-color: #0969da;
    }

    .crop-buttons {
        display: flex;
        gap: 10px;
        width: 100%;
        justify-content: flex-end;
    }

    /* モバイルビュー */
    .mobile-view {
        display: none;
        height: calc(100vh - 5.5rem);
        overflow: hidden;
        transition: height 0.3s ease;
    }

    .mobile-list {
        height: calc(100vh - 5.5rem);
        overflow-y: auto;
        background-color: #F3F6FB;
        transition: height 0.3s ease;
    }

    .mobile-header {
        padding: 15px;
        background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .back-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
    }

    .mobile-title {
        flex: 1;
        font-size: 18px;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .mobile-editor {
        height: calc(100vh - 5.5rem);
        display: flex;
        flex-direction: column;
        background-color: #fff;
        transition: height 0.3s ease;
    }

    .mobile-editor-header {
        padding: 15px;
        background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .mobile-editor-title {
        flex: 1;
        font-size: 18px;
        font-weight: bold;
    }

    .mobile-editor-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    /* レスポンシブ */
    @@media (max-width: 768px) {
        .desktop-view {
            display: none !important;
        }

        .mobile-view {
            display: block;
            width: 100%;
        }

        .sidebar-toggle,
        .sidebar-open-btn {
            display: none;
        }

        .sidebar.collapsed {
            margin-left: 0;
            width: 300px;
        }

        .character-editor-layout {
            flex-direction: column;
            align-items: center;
        }

        .character-fields-section {
            width: 100%;
        }

        .image-placeholder {
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }

        .field-row {
            flex-direction: column;
        }

        .image-square {
            width: 140px;
            height: 140px;
        }
    }

    .mobile-category-ui {
        position: sticky;
        display: flex;
        align-items: center;
        justify-content: center;
        bottom: 0;
        width: max-content;
        margin: 0 auto;
    }

    .category-select-button {
        width: 64px;
        height: 64px;
        cursor: pointer;
        line-height: 64px;
        text-align: center;
        background-color: #ECEFF1;
        border: 1px solid rgba(25, 118, 210, 0.15);
        color: #546E7A;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
        z-index: 100;
    }

        .category-select-button + .category-select-button {
            border-left: none;
        }

        .category-select-button:first-child {
            border-top-left-radius: 10%;
            border-bottom-left-radius: 10%;
        }

        .category-select-button:last-child {
            border-top-right-radius: 10%;
            border-bottom-right-radius: 10%;
        }

        .category-select-button:hover {
            background-color: #E3F2FD;
            color: #1976D2;
        }

        .category-select-button.active {
            background: linear-gradient(135deg, #1976D2, #1565C0);
            color: white;
            box-shadow: inset 0 -2px 4px rgba(0,0,0,0.15);
        }

            .category-select-button.active:hover {
                background: linear-gradient(135deg, #1565C0, #0D47A1);
            }
</style>

@if (_project == null) {
    <p>Loading...</p>
} else {
    <!-- デスクトップビュー -->
    <div class="edit-container desktop-view">
        <!-- サイドバー開くボタン -->
        @if (_sidebarCollapsed) {
            <button class="sidebar-open-btn" @onclick="ToggleSidebar">▶</button>
        }

        <!-- 左サイドバー：カテゴリ一覧またはナビゲーション -->
        <div class="sidebar @(_sidebarCollapsed ? "collapsed" : "")">
            @if (_showCategoryView) {
                <div class="sidebar-header" @onclick="BackToCategoryView">
                    &lt; カテゴリ選択に戻る
                </div>
                <div class="category-view">
                    @if (_project.ProjectDataObject?.Character?.Category != null && _project.ProjectDataObject.Character.Category.Length > 0) {
                        @for (int i = 0; i < _project.ProjectDataObject.Character.Category.Length; i++) {
                            var category = _project.ProjectDataObject.Character.Category[i];
                            var index = i;
                            <div class="category-item @(category == _selectedCategory ? "active" : "") @GetDragClass(index)"
                                 draggable="true"
                                 @ondragstart="() => HandleDragStart(index)"
                                 @ondragover="(e) => HandleDragOver(e, index)"
                                 @ondragover:preventDefault="true"
                                 @ondragleave="HandleDragLeave"
                                 @ondrop="() => HandleDrop(index)"
                                 @ondragend="HandleDragEnd"
                                 @onclick="() => SelectCharacterCategory(category)">
                                <span class="category-title">
                                    <span class="category-count">(@(category.Characters?.Length ?? 0)件)</span>
                                    <span class="category-name">@category.Title</span>
                                </span>
                                <div class="category-actions">
                                    <button class="icon-btn" @onclick="() => ShowRenameCategoryModal(category)" @onclick:stopPropagation="true">✎</button>
                                    <button class="icon-btn delete" @onclick="() => ShowDeleteCategoryConfirm(category)" @onclick:stopPropagation="true">−</button>
                                </div>
                            </div>
                        }
                    } else {
                        <div class="empty-state category-bar">
                            <div>人物カテゴリがありません</div>
                        </div>
                    }
                    <button class="add-category-btn" @onclick="ShowAddCategoryModal">+ カテゴリを追加</button>
                </div>
            } else {
                <div class="sidebar-header" @onclick="BackToProjectList">
                    &lt; プロジェクト一覧に戻る
                </div>
                <div class="category-view">
                    <div class="category-item" @onclick='() => SelectCategory("writing")'>
                        執筆
                    </div>
                    <div class="category-item" @onclick='() => SelectCategory("structure")'>
                        構成
                    </div>
                    <div class="category-item @(_currentCategory == "characters" ? "active" : "")" @onclick='() => SelectCategory("characters")'>
                        人物
                    </div>
                    <div class="category-item" @onclick='() => SelectCategory("materials")'>
                        資料
                    </div>
                </div>
            }
            @if (!_sidebarCollapsed) {
                <button class="sidebar-toggle" @onclick="ToggleSidebar">◀</button>
            }
        </div>

        <!-- 中央パネル：人物リスト -->
        @if (_showCategoryView && _selectedCategory != null) {
            <div class="character-list-panel">
                <div class="character-list-header">
                    人物一覧: @(_selectedCategory.Title ?? "")
                </div>
                <div class="character-view">
                    @if (_selectedCategory.Characters != null && _selectedCategory.Characters.Length > 0) {
                        @for (int i = 0; i < _selectedCategory.Characters.Length; i++) {
                            var item = _selectedCategory.Characters[i];
                            var index = i;
                            <div class="character-item @(item == _selectedCharacter ? "active" : "") @GetCharacterDragClass(index)"
                                 draggable="true"
                                 @ondragstart="() => HandleCharacterDragStart(index)"
                                 @ondragover="(e) => HandleCharacterDragOver(e, index)"
                                 @ondragover:preventDefault="true"
                                 @ondragleave="HandleCharacterDragLeave"
                                 @ondrop="() => HandleCharacterDrop(index)"
                                 @ondragend="HandleCharacterDragEnd"
                                 @onclick="() => SelectCharacter(item)">
                                @if (item.Image != null && item.Image.Length > 0) {
                                    <img class="character-thumbnail"
                                         src="data:image/jpeg;base64,@Convert.ToBase64String(item.Image)"
                                         alt="@item.Name" />
                                } else {
                                    <div class="character-thumbnail-placeholder">👤</div>
                                }
                                <div class="character-item-info">
                                    <span class="character-item-name">
                                        @if (string.IsNullOrEmpty(item.Name)) {
                                            <div style="color: gray">(名前未設定)</div>
                                        } else {
                                            @item.Name
                                        }
                                    </span>
                                    @if (!string.IsNullOrEmpty(item.NameRuby)) {
                                        <span class="character-item-ruby">@item.NameRuby</span>
                                    }
                                </div>
                                <div class="character-actions">
                                    <button class="icon-btn delete" @onclick="() => ShowDeleteCharacterConfirm(item)" @onclick:stopPropagation="true">−</button>
                                </div>
                            </div>
                        }
                    } else {
                        <div class="empty-state character-bar">
                            <div>人物がありません</div>
                        </div>
                    }
                    <button class="add-character-btn" @onclick="SaveCharacter">+ 人物を追加</button>
                </div>
            </div>
        }

        <!-- 右側エディタエリア -->
        <div class="editor-area">
            @if (_showCategoryView && _selectedCharacter != null) {
                <div class="editor-content">
                    <div class="character-editor-layout">
                        <!-- 画像エリア -->
                        <div class="character-image-section">
                            <div class="image-square">
                                @if (_selectedCharacter.Image != null && _selectedCharacter.Image.Length > 0) {
                                    <img src="data:image/jpeg;base64,@Convert.ToBase64String(_selectedCharacter.Image)"
                                         alt="@_selectedCharacter.Name" />
                                } else {
                                    <div class="image-square-placeholder">
                                        <div>画像なし</div>
                                    </div>
                                }
                            </div>
                            <label class="image-upload-label">
                                画像をアップロード
                                <InputFile style="display:none" accept="image/*"
                                           OnChange="HandleImageUpload" />
                            </label>
                            @if (_selectedCharacter.Image != null && _selectedCharacter.Image.Length > 0) {
                                <button class="image-clear-btn" @onclick="ClearImage">画像を削除</button>
                            }
                        </div>

                        <!-- テキストフィールド -->
                        <div class="character-fields-section">
                            <div class="field-group">
                                <label>名前</label>
                                <input type="text" class="field-input"
                                       @bind="_selectedCharacter.Name" @bind:event="oninput"
                                       placeholder="キャラクター名" />
                            </div>
                            <div class="field-group">
                                <label>読み仮名</label>
                                <input type="text" class="field-input"
                                       @bind="_selectedCharacter.NameRuby" @bind:event="oninput"
                                       placeholder="よみがな" />
                            </div>
                            <div class="field-group">
                                <label>別名・通称</label>
                                <input type="text" class="field-input"
                                       @bind="_selectedCharacter.Alias" @bind:event="oninput"
                                       placeholder="あだ名、通称など" />
                            </div>
                            <div class="field-row">
                                <div class="field-group">
                                    <label>種族</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Species" @bind:event="oninput"
                                           placeholder="例: 人間" />
                                </div>
                                <div class="field-group">
                                    <label>職業・役職</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Job" @bind:event="oninput"
                                           placeholder="例: 魔法使い" />
                                </div>
                            </div>
                            <div class="field-row">
                                <div class="field-group">
                                    <label>年齢</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Age" @bind:event="oninput"
                                           placeholder="例: 17歳" />
                                </div>
                                <div class="field-group">
                                    <label>性別</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Gender" @bind:event="oninput"
                                           placeholder="例: 女性" />
                                </div>
                            </div>
                            <div class="field-row">
                                <div class="field-group">
                                    <label>身長</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Stature" @bind:event="oninput"
                                           placeholder="例: 162cm" />
                                </div>
                                <div class="field-group">
                                    <label>体重</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Weight" @bind:event="oninput"
                                           placeholder="例: 50kg" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 概要エディタ -->
                    <div class="overview-section">
                        <div class="overview-toolbar">
                            <button class="toolbar-btn" title="大見出し"
                                    @onclick="() => ApplyHeading(1)">
                                H1
                            </button>
                            <button class="toolbar-btn" title="中見出し"
                                    @onclick="() => ApplyHeading(2)">
                                H2
                            </button>
                            <button class="toolbar-btn" title="小見出し"
                                    @onclick="() => ApplyHeading(3)">
                                H3
                            </button>
                            <button class="toolbar-btn" title="解除"
                                    @onclick="() => ApplyHeading(0)">
                                ×
                            </button>
                        </div>
                        <div class="overview-editor-wrap" id="overview-editor" @key="@($"overview-{_selectedCharacter?.GetHashCode()}")" @oninput="OnOverviewInput"
                             contenteditable="true"></div>
                    </div>
                </div>
            } else if (_showCategoryView && _selectedCategory != null) {
                <div class="empty-state">
                    <div>人物を選択してください</div>
                </div>
            } else {
                @if (_showCategoryView) {
                    <div class="empty-state">
                        人物カテゴリを選択してください
                    </div>
                } else {
                    <div class="empty-state">
                        左のサイドバーからカテゴリーを選択してください
                    </div>
                }
            }
        </div>
    </div>

    <!-- モバイルビュー -->
    <div class="mobile-view">
        @if (_mobileShowEditor) {
            <div class="mobile-editor">
                <div class="mobile-editor-header">
                    <button class="back-btn" @onclick="BackToCharacterList">&lt;</button>
                    <div class="mobile-editor-title">カテゴリ: @(_selectedCategory?.Title ?? "人物")</div>
                </div>
                <div class="mobile-editor-content">
                    @if (_selectedCharacter != null) {
                        <div class="character-editor-layout">
                            <div class="character-image-section">
                                <div class="image-square">
                                    @if (_selectedCharacter.Image != null && _selectedCharacter.Image.Length > 0) {
                                        <img src="data:image/jpeg;base64,@Convert.ToBase64String(_selectedCharacter.Image)"
                                             alt="@_selectedCharacter.Name" />
                                    } else {
                                        <div class="image-square-placeholder">
                                            <div>画像なし</div>
                                        </div>
                                    }
                                </div>
                                <label class="image-upload-label">
                                    画像をアップロード
                                    <InputFile style="display:none" accept="image/*"
                                               OnChange="HandleImageUpload" />
                                </label>
                                @if (_selectedCharacter.Image != null && _selectedCharacter.Image.Length > 0) {
                                    <button class="image-clear-btn" @onclick="ClearImage">画像を削除</button>
                                }
                            </div>
                            <div class="character-fields-section">
                                <div class="field-group">
                                    <label>名前</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Name" @bind:event="oninput"
                                           placeholder="キャラクター名" />
                                </div>
                                <div class="field-group">
                                    <label>読み仮名</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.NameRuby" @bind:event="oninput"
                                           placeholder="よみがな" />
                                </div>
                                <div class="field-group">
                                    <label>別名・通称</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Alias" @bind:event="oninput"
                                           placeholder="あだ名、通称など" />
                                </div>
                                <div class="field-group">
                                    <label>種族</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Species" @bind:event="oninput"
                                           placeholder="例: 人間" />
                                </div>
                                <div class="field-group">
                                    <label>職業・役職</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Job" @bind:event="oninput"
                                           placeholder="例: 魔法使い" />
                                </div>
                                <div class="field-group">
                                    <label>年齢</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Age" @bind:event="oninput"
                                           placeholder="例: 17歳" />
                                </div>
                                <div class="field-group">
                                    <label>性別</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Gender" @bind:event="oninput"
                                           placeholder="例: 女性" />
                                </div>
                                <div class="field-group">
                                    <label>身長</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Stature" @bind:event="oninput"
                                           placeholder="例: 162cm" />
                                </div>
                                <div class="field-group">
                                    <label>体重</label>
                                    <input type="text" class="field-input"
                                           @bind="_selectedCharacter.Weight" @bind:event="oninput"
                                           placeholder="例: 50kg" />
                                </div>
                            </div>
                        </div>
                        <div class="overview-section">
                            <div class="overview-toolbar">
                                <button class="toolbar-btn" @onclick="() => ApplyHeading(1)">H1</button>
                                <button class="toolbar-btn" @onclick="() => ApplyHeading(2)">H2</button>
                                <button class="toolbar-btn" @onclick="() => ApplyHeading(3)">H3</button>
                                <button class="toolbar-btn" @onclick="() => ApplyHeading(0)">×</button>
                            </div>
                            <div class="overview-editor-wrap" id="overview-editor-mobile" @key="@($"overview-mobile-{_selectedCharacter?.GetHashCode()}")" @oninput="OnOverviewInput"
                                 contenteditable="true"></div>
                        </div>
                    }
                </div>
            </div>
        } else if (_mobileShowCharacterList) {
            <div class="mobile-list">
                <div class="mobile-header">
                    <button class="back-btn" @onclick="BackToCategoryListMobile">&lt;</button>
                    <div class="mobile-title">カテゴリ: @(_selectedCategory?.Title ?? "人物")</div>
                </div>
                <div class="character-view">
                    @if (_selectedCategory?.Characters != null && _selectedCategory.Characters.Length > 0) {
                        @for (int i = 0; i < _selectedCategory.Characters.Length; i++) {
                            var item = _selectedCategory.Characters[i];
                            var index = i;
                            <div class="character-item @GetCharacterDragClass(index)"
                                 draggable="true"
                                 @ondragstart="() => HandleCharacterDragStart(index)"
                                 @ondragover="(e) => HandleCharacterDragOver(e, index)"
                                 @ondragover:preventDefault="true"
                                 @ondragleave="HandleCharacterDragLeave"
                                 @ondrop="() => HandleCharacterDrop(index)"
                                 @ondragend="HandleCharacterDragEnd"
                                 @onclick="() => SelectCharacterMobile(item)">
                                @if (item.Image != null && item.Image.Length > 0) {
                                    <img class="character-thumbnail"
                                         src="data:image/jpeg;base64,@Convert.ToBase64String(item.Image)"
                                         alt="@item.Name" />
                                } else {
                                    <div class="character-thumbnail-placeholder">👤</div>
                                }
                                <div class="character-item-info">
                                    @if (string.IsNullOrEmpty(item.Name)) {
                                        <div style="color: gray;">(名前未設定)</div>
                                    } else {
                                        @item.Name
                                    }
                                    @if (!string.IsNullOrEmpty(item.NameRuby)) {
                                        <span class="character-item-ruby">@item.NameRuby</span>
                                    }
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="icon-btn delete" @onclick="() => ShowDeleteCharacterConfirm(item)" @onclick:stopPropagation="true">−</button>
                                </div>
                            </div>
                        }
                    } else {
                        <div class="empty-state character-bar">
                            <div>人物がありません</div>
                        </div>
                    }
                    <button class="add-character-btn mobile" @onclick="SaveCharacter">＋</button>
                </div>
            </div>
        } else {
            <div class="mobile-list">
                <div class="mobile-header">
                    <button class="back-btn" @onclick="BackToProjectList">&lt;</button>
                    <div class="mobile-title">プロジェクト一覧に戻る</div>
                </div>
                <div class="category-view">
                    @if (_project.ProjectDataObject?.Character?.Category != null && _project.ProjectDataObject.Character.Category.Length > 0) {
                        @for (int i = 0; i < _project.ProjectDataObject.Character.Category.Length; i++) {
                            var category = _project.ProjectDataObject.Character.Category[i];
                            var index = i;
                            <div class="category-item @GetDragClass(index)"
                                 draggable="true"
                                 @ondragstart="() => HandleDragStart(index)"
                                 @ondragover="(e) => HandleDragOver(e, index)"
                                 @ondragover:preventDefault="true"
                                 @ondragleave="HandleDragLeave"
                                 @ondrop="() => HandleDrop(index)"
                                 @ondragend="HandleDragEnd"
                                 @onclick="() => SelectCharacterCategoryMobile(category)">
                                <div class="category-title">
                                    <div class="category-count">(@(category.Characters?.Length ?? 0)件)</div>
                                    <div class="category-name">@category.Title</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="icon-btn" @onclick="() => ShowRenameCategoryModal(category)" @onclick:stopPropagation="true">✎</button>
                                    <button class="icon-btn delete" @onclick="() => ShowDeleteCategoryConfirm(category)" @onclick:stopPropagation="true">−</button>
                                </div>
                            </div>
                        }
                    } else {
                        <div class="empty-state category-bar">
                            <div>人物カテゴリがありません</div>
                        </div>
                    }
                    <button class="add-category-btn mobile" @onclick="ShowAddCategoryModal">＋</button>
                </div>
            </div>
        }
        @if (!_mobileShowEditor) {
            <div class="mobile-category-ui">
                <div class="category-select-button" @onclick='() => SelectCategory("writing")'>執筆</div>
                <div class="category-select-button" @onclick='() => SelectCategory("structure")'>構成</div>
                <div class="category-select-button active" @onclick='() => SelectCategory("characters")'>人物</div>
                <div class="category-select-button" @onclick='() => SelectCategory("materials")'>資料</div>
            </div>
        }
    </div>


    <!-- カテゴリ追加/編集モーダル -->
    @if (_showCategoryModal) {
        <div class="modal-overlay" @onclick="CloseCategoryModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">@(_isEditingCategory ? "カテゴリ名を編集" : "新しいカテゴリ")</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" placeholder="カテゴリ名を入力" @bind="_categoryModalTitle" @bind:event="oninput" @onkeydown="HandleCategoryModalKeyDown" />
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-cancel" @onclick="CloseCategoryModal">キャンセル</button>
                    <button class="modal-btn modal-btn-primary" @onclick="SaveCategory">保存</button>
                </div>
            </div>
        </div>
    }

    <!-- カテゴリ削除確認モーダル -->
    @if (_showDeleteCategoryConfirm) {
        <div class="modal-overlay" @onclick="CloseDeleteCategoryConfirm">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">カテゴリの削除</div>
                <div class="modal-body">
                    <p>このカテゴリを削除してもよろしいですか？</p>
                    <p style="color: #dc3545; margin-top: 10px;">※このカテゴリに含まれるすべての人物も削除されます。</p>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" @onclick="CloseDeleteCategoryConfirm">キャンセル</button>
                    <button class="modal-btn modal-btn-danger" @onclick="DeleteCategory">削除</button>
                </div>
            </div>
        </div>
    }

    <!-- 人物削除確認モーダル -->
    @if (_showDeleteCharacterConfirm) {
        <div class="modal-overlay" @onclick="CloseDeleteCharacterConfirm">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">人物の削除</div>
                <div class="modal-body">
                    <p>この人物を削除してもよろしいですか？</p>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" @onclick="CloseDeleteCharacterConfirm">キャンセル</button>
                    <button class="modal-btn modal-btn-danger" @onclick="DeleteCharacter">削除</button>
                </div>
            </div>
        </div>
    }

    <!-- 画像トリミングモーダル -->
    @if (_showCropModal) {
        <div class="crop-modal-overlay">
            <div class="crop-modal-content" @onclick:stopPropagation="true">
                <div class="crop-modal-title">画像をトリミング</div>
                <div class="crop-viewport" id="crop-viewport">
                    <img class="crop-image" id="crop-image" src="" alt="" />
                    <div class="crop-grid"></div>
                </div>
                <div class="crop-controls">
                    <label>拡大縮小</label>
                    <input type="range" class="crop-slider" id="crop-scale-slider"
                           min="10" max="300" value="100"
                           @oninput="OnCropSliderInput" />
                </div>
                <div class="crop-buttons">
                    <button class="modal-btn modal-btn-cancel" @onclick="async () => await CancelCrop()">キャンセル</button>
                    <button class="modal-btn modal-btn-primary" @onclick="ConfirmCrop">決定</button>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter]
    public int id { get; set; }

    private Project? _project;
    private string _currentCategory = "characters";
    private bool _showCategoryView = true;
    private bool _mobileShowEditor = false;
    private bool _mobileShowCharacterList = false;
    private CharacterCategory? _selectedCategory;
    private Character? _selectedCharacter;
    private byte[]? _tempImage = null;
    private string? _tempImageMime = null;
    private static Dictionary<string, Characters> _instances = new Dictionary<string, Characters>();
    private string _instanceId = Guid.NewGuid().ToString();

    private Character? _lastRenderedCharacter = null;
    private System.Threading.Timer? _overviewSaveTimer;
    private bool _hasPendingContentSave = false;
    private System.Threading.Timer? _autoSaveTimer;
    private SemaphoreSlim _saveSemaphore = new SemaphoreSlim(1, 1);

    // モーダル関連
    private bool _showCategoryModal = false;
    private string _categoryModalTitle = "";
    private bool _isEditingCategory = false;
    private bool _showDeleteCategoryConfirm = false;
    private bool _showDeleteCharacterConfirm = false;
    private CharacterCategory? _editingCategory;
    private Character? _editingCharacter;
    // 画像トリミング
    private bool _showCropModal = false;
    private byte[]? _pendingImageBytes = null;
    private string _pendingImageMime = "image/jpeg";
    private int _cropScale = 100;

    // サイドバー
    private bool _sidebarCollapsed = false;

    // デスクトップ/モバイル判定
    private bool _isResizing = false;

    protected override async Task OnInitializedAsync() {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var appUser = await UserManager.GetUserAsync(user);
        var userId = appUser.Id;

        _project = await DbFactory
            .CreateDbContext()
            .Projects
            .Where(x => x.Id == id && x.UserId == userId)
            .FirstOrDefaultAsync();

        if (_project == null) {
            Nav.NavigateTo("/projects");
            return;
        }

        // CharacterDataの初期化
        if (_project.ProjectDataObject.Character == null) {
            _project.ProjectDataObject.Character = new CharacterData();
        }

        if (_project.ProjectDataObject.Character.Category == null) {
            _project.ProjectDataObject.Character.Category = Array.Empty<CharacterCategory>();
        }
    }

    private DotNetObjectReference<Characters>? dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            await JSRuntime.InvokeVoidAsync("initializeEditorEventListeners", _instanceId);
            await JSRuntime.InvokeVoidAsync("setBlazorInstance", DotNetObjectReference.Create(this));
        }

        bool needUpdate = (_selectedCharacter != _lastRenderedCharacter || _isResizing);

        // デスクトップとモバイル間の同期
        if (needUpdate && _selectedCharacter != null) {
            await JSRuntime.InvokeVoidAsync("setOverviewContent", "overview-editor", _selectedCharacter.Overview ?? "");
            await JSRuntime.InvokeVoidAsync("setOverviewContent", "overview-editor-mobile", _selectedCharacter.Overview ?? "");
            await JSRuntime.InvokeVoidAsync("adjustContainerHeight");
            _lastRenderedCharacter = _selectedCharacter;
            _isResizing = false;
        }
    }

    protected override void OnInitialized() {
        base.OnInitialized();
        _instances[_instanceId] = this;
    }

    private async Task OnOverviewInput() {
        _hasPendingContentSave = true;

        _overviewSaveTimer?.Dispose();

        _overviewSaveTimer = new System.Threading.Timer(async _ => {
            if (_hasPendingContentSave) {
                await InvokeAsync(async () => {
                    try {
                        await SaveOverviewContent();
                        ScheduleAutoSave();
                        _hasPendingContentSave = false;
                    }
                    catch (Exception ex) {
                        Console.WriteLine($"OnContentInput error: {ex.Message}");
                    }
                });
            }
        }, null, 500, Timeout.Infinite);
    }

    private void ScheduleAutoSave() {
        _autoSaveTimer?.Dispose();
        _autoSaveTimer = new System.Threading.Timer(async _ => {
            await InvokeAsync(async () => {
                await AutoSave();
            });
        }, null, 1000, Timeout.Infinite);
    }

    private async Task AutoSave() {
        if (!await _saveSemaphore.WaitAsync(0)) {
            return;
        }

        try {
            if (_project != null) {
                _project.UpdatedAt = DateTime.UtcNow;

                // リトライロジック
                int maxRetries = 3;
                for (int i = 0; i < maxRetries; i++) {
                    try {
                        await using var db = DbFactory.CreateDbContext();
                        db.Projects.Update(_project);
                        await db.SaveChangesAsync();
                        break; // 成功したらループを抜ける
                    }
                    catch (Exception ex) when (i < maxRetries - 1) {
                        Console.WriteLine($"AutoSave attempt {i + 1} failed: {ex.Message}");
                        await Task.Delay(500 * (i + 1)); // リトライ前に待機
                    }
                }
            }
        }
        catch (Exception ex) {
            Console.WriteLine($"AutoSave error: {ex.Message}");
        }
        finally {
            _saveSemaphore.Release();
        }
    }

    private async Task SaveOverviewContent() {

        var content = "";

        try {
            using var context = await DbFactory.CreateDbContextAsync();

            // カテゴリを検索してキャラクターを更新
            foreach (var category in _project.ProjectDataObject.Character.Category) {
                var character = category.Characters?.FirstOrDefault(c => c == _selectedCharacter);
                if (_mobileShowEditor) {
                    content = await JSRuntime.InvokeAsync<string>("getOverviewContent", "overview-editor-mobile");
                } else {
                    content = await JSRuntime.InvokeAsync<string>("getOverviewContent", "overview-editor");
                }
                if (character != null) {
                    if (character.Overview == content) {
                        return;
                    }
                    character.Overview = content;
                    break;
                }
            }
        }
        catch (Exception ex) {
            Console.WriteLine($"Overview保存エラー: {ex.Message}");
        }
    }

    private async Task BackToCategoryView() {
        if (_selectedCharacter != null) {
            await SaveOverviewContent();
        }
        await SaveProject();
        _showCategoryView = false;
        _selectedCharacter = null;
        _lastRenderedCharacter = null;
        StateHasChanged();
    }

    private async Task BackToProjectList() {
        if (_selectedCharacter != null) {
            await SaveOverviewContent();
        }
        await SaveProject();
        Nav.NavigateTo("/projects");
    }

    private async Task SaveProject() {
        if (_project != null && _project.ProjectDataObject != null) {
            _project.UpdatedAt = DateTime.UtcNow;
            await using var db = DbFactory.CreateDbContext();
            db.Projects.Update(_project);
            await db.SaveChangesAsync();
        }
    }

    private async Task SelectCategory(string category) {
        _currentCategory = category;
        if (category == "writing") {
            await SaveProject();
            Nav.NavigateTo($"/projects/edit/{id}");
        } else if (category == "structure") {
            await SaveProject();
            Nav.NavigateTo($"/projects/edit/{id}/structure");
        } else if (category == "characters") {
            _showCategoryView = true;
        } else if (category == "materials") {
            await SaveProject();
            Nav.NavigateTo($"/projects/edit/{id}/materials");
        }

        StateHasChanged();
    }

    private async Task SelectCharacterCategory(CharacterCategory category) {
        if (_selectedCharacter != null) {
            await SaveOverviewContent();
            await SaveProject();
        }
        _selectedCategory = category;
        _selectedCharacter = category.Characters?.FirstOrDefault();
        _lastRenderedCharacter = null;
        StateHasChanged();
    }

    private async Task SelectCharacter(Character character) {
        if (_selectedCharacter != null) {
            await SaveOverviewContent();
            await SaveProject();
        }
        _selectedCharacter = character;
        _lastRenderedCharacter = null;
        StateHasChanged();
    }

    // モバイル用
    private async Task SelectCharacterCategoryMobile(CharacterCategory category) {
        if (_selectedCharacter != null) {
            await SaveOverviewContent();
            await SaveProject();
        }
        _selectedCategory = category;
        _mobileShowCharacterList = true;
        _lastRenderedCharacter = null;
        StateHasChanged();
    }

    private async Task SelectCharacterMobile(Character character) {
        if (_selectedCharacter != null) {
            await SaveOverviewContent();
            await SaveProject();
        }
        _selectedCharacter = character;
        _mobileShowEditor = true;
        _lastRenderedCharacter = null;
        StateHasChanged();
    }

    private async Task BackToCategoryListMobile() {
        if (_selectedCharacter != null) {
            await SaveOverviewContent();
            await SaveProject();
        }
        _mobileShowCharacterList = false;
        _selectedCategory = null;
        StateHasChanged();
    }

    private async Task BackToCharacterList() {
        if (_selectedCharacter != null) {
            await SaveOverviewContent();
            await SaveProject();
        }
        _mobileShowEditor = false;
        _selectedCharacter = null;
        StateHasChanged();
    }

    // カテゴリ追加モーダル
    private void ShowAddCategoryModal() {
        var categoryCount = _project?.ProjectDataObject?.Character?.Category?.Length ?? 0;
        _categoryModalTitle = $"カテゴリ{categoryCount + 1}";
        _isEditingCategory = false;
        _editingCategory = null;
        _showCategoryModal = true;
    }

    private void ShowRenameCategoryModal(CharacterCategory category) {
        _categoryModalTitle = category.Title;
        _isEditingCategory = true;
        _editingCategory = category;
        _showCategoryModal = true;
    }

    private void CloseCategoryModal() {
        _showCategoryModal = false;
        _categoryModalTitle = "";
        _isEditingCategory = false;
        _editingCategory = null;
    }

    private async Task HandleCategoryModalKeyDown(KeyboardEventArgs e) {
        if (e.Key == "Enter") {
            await SaveCategory();
        } else if (e.Key == "Escape") {
            CloseCategoryModal();
        }
    }

    private async Task SaveCategory() {
        if (string.IsNullOrWhiteSpace(_categoryModalTitle)) {
            return;
        }

        if (_isEditingCategory && _editingCategory != null) {
            _editingCategory.Title = _categoryModalTitle;
        } else {
            var newCategory = new CharacterCategory {
                Title = _categoryModalTitle,
                Characters = Array.Empty<Character>()
            };

            var categories = _project.ProjectDataObject.Character.Category?.ToList() ?? new List<CharacterCategory>();
            categories.Add(newCategory);
            _project.ProjectDataObject.Character.Category = categories.ToArray();
        }

        await SaveProject();
        CloseCategoryModal();
        StateHasChanged();
    }

    private void ShowDeleteCategoryConfirm(CharacterCategory category) {
        _showDeleteCategoryConfirm = true;
        _editingCategory = category;
    }

    private void CloseDeleteCategoryConfirm() {
        _showDeleteCategoryConfirm = false;
        _editingCategory = null;
    }

    private async Task DeleteCategory() {
        if (_project.ProjectDataObject?.Character?.Category != null) {
            var categories = _project.ProjectDataObject.Character.Category.ToList();
            var category = _editingCategory;
            categories.Remove(category);
            _project.ProjectDataObject.Character.Category = categories.ToArray();

            if (_selectedCategory == category) {
                _selectedCategory = null;
                _selectedCharacter = null;
            }

            await SaveProject();
            CloseDeleteCategoryConfirm();
            StateHasChanged();
        }
    }

    private async Task SaveCharacter() {
        var characterCount = _selectedCategory.Characters?.Length ?? 0;
        var newCharacter = new Character {
            Name = "キャラクター" + characterCount,
        };

        var items = _selectedCategory.Characters?.ToList() ?? new List<Character>();
        items.Add(newCharacter);
        _selectedCategory.Characters = items.ToArray();
        _selectedCharacter = newCharacter;

        await SaveProject();
        StateHasChanged();
    }

    private void ShowDeleteCharacterConfirm(Character character) {
        _showDeleteCharacterConfirm = true;
        _editingCharacter = character;
    }

    private void CloseDeleteCharacterConfirm() {
        _showDeleteCharacterConfirm = false;
        _editingCharacter = null;
    }

    private async Task DeleteCharacter() {
        if (_selectedCategory?.Characters != null) {
            var items = _selectedCategory.Characters.ToList();
            var character = _editingCharacter;
            items.Remove(character);
            _selectedCategory.Characters = items.ToArray();

            if (_selectedCharacter == character) {
                _selectedCharacter = _selectedCategory.Characters?.FirstOrDefault();
            }

            await SaveProject();
            CloseDeleteCharacterConfirm();
            StateHasChanged();
        }
    }

    private void ToggleSidebar() {
        _sidebarCollapsed = !_sidebarCollapsed;
    }

    // ドラッグアンドドロップ用の変数を追加
    private int _dragSourceIndex = -1;
    private int _dragOverIndex = -1;
    private bool _dragOverBottom = false;

    // ドラッグアンドドロップ用のメソッドを追加
    private void HandleDragStart(int index) {
        _dragSourceIndex = index;
    }

    private void HandleDragEnd() {
        _dragSourceIndex = -1;
        _dragOverIndex = -1;
        _dragOverBottom = false;
    }

    private void HandleDragOver(DragEventArgs e, int index) {
        _dragOverIndex = index;
        // 要素の高さの半分より下にマウスがある場合は下に挿入
        _dragOverBottom = e.OffsetY > 20;
    }

    private void HandleDragLeave() {
        _dragOverIndex = -1;
        _dragOverBottom = false;
    }

    private string GetDragClass(int index) {
        if (_dragSourceIndex == index) {
            return "dragging";
        }

        if (_dragOverIndex == index) {
            return _dragOverBottom ? "drag-over-bottom" : "drag-over-top";
        }

        return "";
    }

    private async Task HandleDrop(int targetIndex) {
        if (_dragSourceIndex == -1 || _dragSourceIndex == targetIndex) {
            HandleDragEnd();
            return;
        }

        if (_project?.ProjectDataObject?.Character?.Category == null) {
            HandleDragEnd();
            return;
        }

        var categories = _project.ProjectDataObject.Character.Category.ToList();
        var draggedCategory = categories[_dragSourceIndex];

        // 元の位置から削除
        categories.RemoveAt(_dragSourceIndex);

        // 新しい位置に挿入
        int insertIndex = targetIndex;

        // ドラッグ元より前の要素にドロップした場合
        if (_dragSourceIndex > targetIndex) {
            // 上半分なら手前に、下半分なら後ろに挿入
            if (_dragOverBottom) {
                insertIndex++;
            }
        }
        // ドラッグ元より後の要素にドロップした場合
        else {
            // 削除によってインデックスが1つ減っているので調整
            insertIndex--;

            // 下半分なら後ろに挿入
            if (_dragOverBottom) {
                insertIndex++;
            }
        }

        // インデックスの範囲チェック
        if (insertIndex < 0) insertIndex = 0;
        if (insertIndex > categories.Count) insertIndex = categories.Count;

        categories.Insert(insertIndex, draggedCategory);
        _project.ProjectDataObject.Character.Category = categories.ToArray();

        await SaveProject();
        HandleDragEnd();
        StateHasChanged();
    }

    private int _dragSourceCharacterIndex = -1;
    private int _dragOverCharacterIndex = -1;
    private bool _dragOverCharacterBottom = false;

    private void HandleCharacterDragStart(int index) {
        _dragSourceCharacterIndex = index;
    }

    private void HandleCharacterDragEnd() {
        _dragSourceCharacterIndex = -1;
        _dragOverCharacterIndex = -1;
        _dragOverCharacterBottom = false;
    }

    private void HandleCharacterDragOver(DragEventArgs e, int index) {
        _dragOverCharacterIndex = index;
        _dragOverCharacterBottom = e.OffsetY > 20;
    }

    private void HandleCharacterDragLeave() {
        _dragOverCharacterIndex = -1;
        _dragOverCharacterBottom = false;
    }

    private string GetCharacterDragClass(int index) {
        if (_dragSourceCharacterIndex == index) {
            return "dragging";
        }

        if (_dragOverCharacterIndex == index) {
            return _dragOverCharacterBottom ? "drag-over-bottom" : "drag-over-top";
        }

        return "";
    }

    private async Task HandleCharacterDrop(int targetIndex) {
        if (_dragSourceCharacterIndex == -1 || _dragSourceCharacterIndex == targetIndex) {
            HandleCharacterDragEnd();
            return;
        }

        if (_selectedCategory?.Characters == null) {
            HandleCharacterDragEnd();
            return;
        }

        var characters = _selectedCategory.Characters.ToList();
        var draggedCharacter = characters[_dragSourceCharacterIndex];

        characters.RemoveAt(_dragSourceCharacterIndex);

        int insertIndex = targetIndex;

        if (_dragSourceCharacterIndex > targetIndex) {
            if (_dragOverCharacterBottom) {
                insertIndex++;
            }
        } else {
            insertIndex--;
            if (_dragOverCharacterBottom) {
                insertIndex++;
            }
        }

        if (insertIndex < 0) insertIndex = 0;
        if (insertIndex > characters.Count) insertIndex = characters.Count;

        characters.Insert(insertIndex, draggedCharacter);
        _selectedCategory.Characters = characters.ToArray();

        await SaveProject();
        HandleCharacterDragEnd();
        StateHasChanged();
    }

    private void InsertMarkdown(string markdown) {
        if (_selectedCharacter != null) {
            _selectedCharacter.Overview += markdown;
            StateHasChanged();
        }
    }

    // 画像アップロード（一時・保存なし）
    private async Task HandleImageUpload(InputFileChangeEventArgs e) {
        var file = e.File;
        if (file == null) return;

        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        using var ms = new System.IO.MemoryStream();
        await stream.CopyToAsync(ms);
        _pendingImageBytes = ms.ToArray();
        _pendingImageMime = file.ContentType;
        _cropScale = 100;
        _showCropModal = true;
        StateHasChanged();

        // モーダルが描画された後にJS側へ画像をセット
        var base64 = Convert.ToBase64String(_pendingImageBytes);
        await JSRuntime.InvokeVoidAsync("cropEditor.init",
            "crop-viewport", "crop-image", "crop-scale-slider",
            $"data:{_pendingImageMime};base64,{base64}");
    }

    private void OnCropSliderInput(ChangeEventArgs e) {
        if (int.TryParse(e.Value?.ToString(), out var v)) {
            _cropScale = v;
            _ = JSRuntime.InvokeVoidAsync("cropEditor.setScale",
                "crop-viewport", "crop-image", v);
        }
    }

    private async Task CancelCrop() {
        _showCropModal = false;
        _pendingImageBytes = null;
        await JSRuntime.InvokeVoidAsync("cropEditor.destroy");
        StateHasChanged();
    }

    private async Task ConfirmCrop() {
        if (_selectedCharacter == null || _pendingImageBytes == null) return;

        var resultBase64 = await JSRuntime.InvokeAsync<string>(
            "cropEditor.crop", "crop-viewport", "crop-image");

        if (!string.IsNullOrEmpty(resultBase64)) {
            // "data:image/webp;base64,XXXX" または "data:image/jpeg;base64,XXXX"
            var comma = resultBase64.IndexOf(',');
            var data = comma >= 0 ? resultBase64[(comma + 1)..] : resultBase64;
            _selectedCharacter.Image = Convert.FromBase64String(data);
        }

        _showCropModal = false;
        _pendingImageBytes = null;
        await JSRuntime.InvokeVoidAsync("cropEditor.destroy");
        StateHasChanged();
    }

    private void ClearImage() {
        if (_selectedCharacter == null) return;
        _selectedCharacter.Image = null;
        StateHasChanged();
    }

    private async Task ApplyHeading(int level) {
        if (_selectedCharacter == null) return;
        var editorId = _mobileShowEditor ? "overview-editor-mobile" : "overview-editor";
        var result = await JSRuntime.InvokeAsync<string>(
            "overviewEditor.applyHeading", editorId, level);
        _selectedCharacter.Overview = result;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnOverviewChanged(string content) {
        if (_selectedCharacter == null) return;

        _selectedCharacter.Overview = content;

        await SaveProject();
    }

    public void Dispose() {
        try {
            _overviewSaveTimer?.Dispose();
            _autoSaveTimer?.Dispose();
            _saveSemaphore?.Dispose();

            JSRuntime.InvokeVoidAsync("eval", $@"
            window.blazorConnected = false;
            window['editorEventListenersRegistered_{_instanceId}'] = false;
        ");
        }
        catch {
            // 既に切断されている場合は無視
        }

        _instances.Remove(_instanceId);
    }

    [JSInvokable("OnWindowResizeCharacters")]
    public static async Task OnWindowResizeCharacters(string instanceId, int width) {
        if (!_instances.TryGetValue(instanceId, out var instance)) return;

        try {
            await instance.InvokeAsync(async () => {
                bool isMobile = width <= 768;

                if (!isMobile && instance._mobileShowEditor) {
                    await instance.SaveOverviewContent();
                    instance._mobileShowEditor = false;
                    instance._isResizing = true;
                } else if (isMobile && !instance._mobileShowEditor &&
                           (instance._selectedCharacter != null) && (instance._selectedCategory != null)) {
                    await instance.SaveOverviewContent();
                    instance._mobileShowEditor = true;
                    instance._isResizing = true;
                }
                instance.StateHasChanged();
            });
        }
        catch (Exception ex) {
            Console.WriteLine($"OnWindowResizeCharacters error: {ex.Message}");
        }
    }
}

<script>
    (function() {
        // Blazor接続状態を追跡
        let blazorConnected = true;

        // Blazor切断検知
        if (window.Blazor) {
            Blazor.disconnect = new Proxy(Blazor.disconnect || (() => {}), {
                apply: function(target, thisArg, args) {
                    blazorConnected = false;
                    return target.apply(thisArg, args);
                }
            });
        }

        window.initializeEditorEventListeners = function(instanceId) {

            if (window['editorEventListenersRegistered_' + instanceId]) return;
            window['editorEventListenersRegistered_' + instanceId] = true;
            // リサイズ検知
            let resizeTimer;
            window.addEventListener('resize', function() {
                if (!window.blazorConnected) return;
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    if (!window.blazorConnected) return;
                    try {
                        DotNet.invokeMethodAsync('StoryDesignSupportWebApp', 'OnWindowResizeCharacters', instanceId, window.innerWidth);
                    } catch (err) {
                        console.warn('OnWindowResizeCharacters failed:', err);
                    }
                }, 300);
            });

            // Blazor接続状態の初期化
            window.blazorConnected = true;
        };

        window.setBlazorInstance = function(instance) {
            window.blazorInstance = instance;
        };

        window.setOverviewContent = function(elementId, content) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (element.innerHTML !== (content || '')) {
                element.innerHTML = content || '';

                const selection = window.getSelection();
                const range = document.createRange();

                if (element.childNodes.length > 0) {
                    range.setStart(element.childNodes[0], 0);
                    range.collapse(true);
                } else {
                    range.selectNodeContents(element);
                    range.collapse(true);
                }

                selection.removeAllRanges();
                selection.addRange(range);
            }
        };

        window.getOverviewContent = function(elementId) {
            const element = document.getElementById(elementId);
            return element ? element.innerHTML : '';
        };

        function adjustContainerHeight() {
            const topRow = document.querySelector('.top-row');
            const desktopContainer = document.querySelector('.edit-container.desktop-view');
            const mobileContainer = document.querySelector('.mobile-view');
            const mobileView = document.querySelector('.mobile-list');
            const mobileEditor = document.querySelector('.mobile-editor');

            if (topRow) {
                const isCollapsed = topRow.classList.contains('collapsed');
                const height = isCollapsed ? 'calc(100vh - 2rem)' : 'calc(100vh - 5.5rem)';

                if (desktopContainer) desktopContainer.style.height = height;
                if (mobileContainer) mobileContainer.style.height = height;
                if (mobileView) mobileView.style.height = height;
                if (mobileEditor) mobileEditor.style.height = height;
            }
        }

        window.adjustContainerHeight = adjustContainerHeight;
    })();

    window.cropEditor = {
        _state: {},

        init: function (viewportId, imgId, sliderId, src) {
            const vp = document.getElementById(viewportId);
            const img = document.getElementById(imgId);
            if (!vp || !img) return;

            const st = window.cropEditor._state;
            st.offsetX = 0;
            st.offsetY = 0;
            st.scale = 1.0;
            st.dragging = false;
            st.lastX = 0;
            st.lastY = 0;
            st.viewportId = viewportId;
            st.imgId = imgId;
            st.sliderId = sliderId;

            img.onload = function () {
                const vpSize = vp.getBoundingClientRect().width || 400;
                const iw = img.naturalWidth;
                const ih = img.naturalHeight;

                // 短辺がビューポートと一致する初期スケール（はみ出さない最小値）
                const minScale = vpSize / Math.min(iw, ih);
                st.minScale = minScale;
                st.scale = minScale;
                st.baseScale = minScale;

                // 画像を中央に配置
                st.offsetX = (vpSize - iw * st.scale) / 2;
                st.offsetY = (vpSize - ih * st.scale) / 2;
                window.cropEditor._clampOffset();
                window.cropEditor._apply();

                const slider = document.getElementById(sliderId);
                if (slider) {
                    slider.min = 100;
                    slider.max = 300;
                    slider.value = 100;
                }
            };
            img.src = src;

            // マウスドラッグ
            vp.onmousedown = function (e) {
                st.dragging = true;
                st.lastX = e.clientX;
                st.lastY = e.clientY;
                e.preventDefault();
            };
            // グローバルに登録（モーダルを跨いでもドラッグが続く）
            window._cropMouseMove = function (e) {
                if (!st.dragging) return;
                st.offsetX += e.clientX - st.lastX;
                st.offsetY += e.clientY - st.lastY;
                st.lastX = e.clientX;
                st.lastY = e.clientY;
                window.cropEditor._clampOffset();
                window.cropEditor._apply();
            };
            window._cropMouseUp = function () { st.dragging = false; };
            window.addEventListener('mousemove', window._cropMouseMove);
            window.addEventListener('mouseup', window._cropMouseUp);

            // タッチ
            vp.ontouchstart = function (e) {
                if (e.touches.length === 1) {
                    st.dragging = true;
                    st.lastX = e.touches[0].clientX;
                    st.lastY = e.touches[0].clientY;
                }
                e.preventDefault();
            };
            vp.ontouchmove = function (e) {
                if (!st.dragging || e.touches.length !== 1) return;
                st.offsetX += e.touches[0].clientX - st.lastX;
                st.offsetY += e.touches[0].clientY - st.lastY;
                st.lastX = e.touches[0].clientX;
                st.lastY = e.touches[0].clientY;
                window.cropEditor._clampOffset();
                window.cropEditor._apply();
                e.preventDefault();
            };
            vp.ontouchend = function () { st.dragging = false; };
        },

        setScale: function (viewportId, imgId, sliderVal) {
            const st = window.cropEditor._state;
            if (!st.baseScale) return;
            const vp = document.getElementById(viewportId);
            if (!vp) return;
            const vpSize = vp.getBoundingClientRect().width || 400;
            const img = document.getElementById(imgId);
            if (!img) return;

            // sliderVal 100 = minScale（短辺ぴったり）、300 = 3倍
            const newScale = st.baseScale * (sliderVal / 100);

            // ビューポート中心を固定点としてオフセットを再計算
            const cx = vpSize / 2;
            const cy = vpSize / 2;
            const ratio = newScale / st.scale;
            st.offsetX = cx + (st.offsetX - cx) * ratio;
            st.offsetY = cy + (st.offsetY - cy) * ratio;
            st.scale = newScale;
            window.cropEditor._clampOffset();
            window.cropEditor._apply();
        },

        // 画像がビューポートからはみ出さないようオフセットを制限
        _clampOffset: function () {
            const st = window.cropEditor._state;
            const vp = document.getElementById(st.viewportId);
            const img = document.getElementById(st.imgId);
            if (!vp || !img) return;

            const vpSize = vp.getBoundingClientRect().width || 400;
            const scaledW = img.naturalWidth * st.scale;
            const scaledH = img.naturalHeight * st.scale;

            // X軸：画像右端がビューポート右端より左に来てはいけない
            //      画像左端がビューポート左端より右に来てはいけない
            const maxX = 0;
            const minX = vpSize - scaledW;
            st.offsetX = Math.min(maxX, Math.max(minX, st.offsetX));

            const maxY = 0;
            const minY = vpSize - scaledH;
            st.offsetY = Math.min(maxY, Math.max(minY, st.offsetY));
        },

        _apply: function () {
            const st = window.cropEditor._state;
            const img = document.getElementById(st.imgId);
            if (!img) return;
            img.style.width  = (img.naturalWidth  * st.scale) + 'px';
            img.style.height = (img.naturalHeight * st.scale) + 'px';
            img.style.left   = st.offsetX + 'px';
            img.style.top    = st.offsetY + 'px';
        },

        crop: function (viewportId, imgId) {
            const vp = document.getElementById(viewportId);
            const img = document.getElementById(imgId);
            if (!vp || !img) return '';

            const vpSize = vp.getBoundingClientRect().width || 400;
            const st = window.cropEditor._state;

            const canvas = document.createElement('canvas');
            canvas.width  = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');

            // ビューポート座標 → canvas(512x512) の変換比率
            const drawScale = 512 / vpSize;

            ctx.drawImage(
                img,
                0, 0, img.naturalWidth, img.naturalHeight,
                st.offsetX * drawScale,
                st.offsetY * drawScale,
                img.naturalWidth  * st.scale * drawScale,
                img.naturalHeight * st.scale * drawScale
            );

            // WebP 品質0.85で軽量化
            const supportsWebP = canvas.toDataURL('image/webp').startsWith('data:image/webp');
            const mime    = supportsWebP ? 'image/webp' : 'image/jpeg';
            const quality = supportsWebP ? 0.85 : 0.88;
            return canvas.toDataURL(mime, quality);
        },

        destroy: function () {
            // モーダルを閉じる際にグローバルイベントを解除
            if (window._cropMouseMove) {
                window.removeEventListener('mousemove', window._cropMouseMove);
                window._cropMouseMove = null;
            }
            if (window._cropMouseUp) {
                window.removeEventListener('mouseup', window._cropMouseUp);
                window._cropMouseUp = null;
            }
        }
    };

    window.overviewEditor = {

        sync: function (id, content) {
            const el = document.getElementById(id);
            if (!el) return;

            if (!el._overviewInitialized) {
                el._overviewInitialized = true;
                el.contentEditable = 'true';
                el.style.minHeight = '280px';
                el.style.padding = '12px';
                el.style.outline = 'none';
                el.style.fontFamily = 'inherit';
                el.style.fontSize = '15px';
                el.style.lineHeight = '1.8';
                el.style.cursor = 'text';
                el.setAttribute('data-placeholder', '概要を入力してください...');

                el.addEventListener('input', function () {
                    window.overviewEditor._updatePlaceholder(el);
                });
                el.addEventListener('focus', function () {
                    window.overviewEditor._updatePlaceholder(el);
                });
                el.addEventListener('blur', function () {
                    window.overviewEditor._updatePlaceholder(el);
                });
            }

            if (document.activeElement === el) return;

            el.innerHTML = window.overviewEditor._toHtml(content);
            window.overviewEditor._updatePlaceholder(el);
        },

        _toHtml: function (text) {
            if (!text) return '';
            return text.split('\n').map(function (line) {
                if (line.startsWith('### ')) return '<h3>' + line.slice(4) + '</h3>';
                if (line.startsWith('## '))  return '<h2>' + line.slice(3) + '</h2>';
                if (line.startsWith('# '))   return '<h1>' + line.slice(2) + '</h1>';
                if (line === '')             return '<p><br></p>';
                return '<p>' + line + '</p>';
            }).join('');
        },

        serialize: function (id) {
            const el = document.getElementById(id);
            if (!el) return '';
            return Array.from(el.childNodes).map(function (node) {
                const tag = node.nodeName.toLowerCase();
                const text = node.textContent || '';
                if (tag === 'h1') return '# ' + text;
                if (tag === 'h2') return '## ' + text;
                if (tag === 'h3') return '### ' + text;
                return text;
            }).join('\n');
        },

        _updatePlaceholder: function (el) {
            const text = (el.textContent || '').trim();
            const html = (el.innerHTML || '').trim();
            const isEmpty = text === '' || html === '' || html === '<br>';
            if (isEmpty) {
                el.classList.add('is-empty');
            } else {
                el.classList.remove('is-empty');
            }
        },

        applyHeading: function (id, level) {
            const el = document.getElementById(id);
            if (!el) return window.overviewEditor.serialize(id);

            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0) return window.overviewEditor.serialize(id);

            const range = sel.getRangeAt(0);

            function getDirectChild(container) {
                let node = container;
                if (node.nodeType === 3) node = node.parentNode;
                if (node === el) return el.firstChild || null;
                while (node && node.parentNode !== el) {
                    node = node.parentNode;
                    if (!node) return null;
                }
                return node;
            }

            const targetNode = getDirectChild(range.startContainer);
            if (!targetNode || !el.contains(targetNode)) {
                return window.overviewEditor.serialize(id);
            }

            const text = targetNode.textContent || '';
            const newTag = level === 0 ? 'p' : 'h' + level;
            const newNode = document.createElement(newTag);
            newNode.textContent = text;

            if (targetNode.parentNode === el) {
                el.replaceChild(newNode, targetNode);
            } else {
                return window.overviewEditor.serialize(id);
            }

            try {
                const newRange = document.createRange();
                newRange.selectNodeContents(newNode);
                newRange.collapse(false);
                sel.removeAllRanges();
                sel.addRange(newRange);
                newNode.focus();
            } catch (e) {}

            return window.overviewEditor.serialize(id);
        }
    };
</script>